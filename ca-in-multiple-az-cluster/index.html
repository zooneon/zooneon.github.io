<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.14.3"/><meta name="theme-color" content="#663399"/><meta name="description" content="…" data-gatsby-head="true"/><meta property="og:title" content="다중 가용 영역 클러스터에 Cluster Autoscaler 도입하기" data-gatsby-head="true"/><meta property="og:description" content="…" data-gatsby-head="true"/><meta property="og:type" content="website" data-gatsby-head="true"/><meta property="og:url" content="https://blog.zooneon.dev" data-gatsby-head="true"/><meta property="og:locale" content="ko_KR" data-gatsby-head="true"/><meta name="twitter:card" content="summary" data-gatsby-head="true"/><meta name="twitter:creator" content="zooneon" data-gatsby-head="true"/><meta name="twitter:title" content="다중 가용 영역 클러스터에 Cluster Autoscaler 도입하기" data-gatsby-head="true"/><meta name="twitter:description" content="…" data-gatsby-head="true"/><style data-href="/styles.9e907bc32054b7771552.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#ccc;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><style data-styled="" data-styled-version="6.1.17">@font-face{font-family:system;font-style:normal;font-weight:300;src:local('.SFNSText-Light'),local('.HelveticaNeueDeskInterface-Light'),local('.LucidaGrandeUI'),local('Ubuntu Light'),local('Segoe UI Light'),local('Roboto-Light'),local('DroidSans'),local('Tahoma');}/*!sc*/
:root{font-size:10px;}/*!sc*/
body{font-family:'system';margin:0;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;background-color:#ffffff;color:rgba(0, 0, 0, 0.8);min-height:100vh;position:relative;font-size:1.6rem;transition:all 0.3s ease;}/*!sc*/
h1,h2,h3,h4,h5,h6{font-family:sans-serif;color:rgba(0, 0, 0, 0.8);}/*!sc*/
h2{font-size:2.5rem;}/*!sc*/
h3{font-size:2.4rem;}/*!sc*/
h4{font-size:1.6rem;}/*!sc*/
code{font-family:Menlo,Monaco,"Courier New",Courier,monospace;word-break:break-word;background-color:#7F8487;color:#666;padding:0.2rem 0.4rem;border-radius:3px;font-size:0.9em;}/*!sc*/
pre code{word-break:normal;background-color:transparent;padding:0;}/*!sc*/
:not(pre)>code[class*="language-"],pre[class*="language-text"]{background-color:transparent;color:#666;font-size:medium;}/*!sc*/
a{transition:color 0.2s ease;color:#0366d6;}/*!sc*/
blockquote{border-left:4px solid #eee;background-color:#f9f9f9;padding:1rem;margin-left:0;margin-right:0;}/*!sc*/
hr{border:none;height:1px;background-color:#eee;}/*!sc*/
table{border-collapse:collapse;width:100%;margin:1rem 0;}/*!sc*/
th,td{border:1px solid #eee;padding:0.5rem;}/*!sc*/
th{background-color:#f5f5f5;}/*!sc*/
img{max-width:100%;height:auto;}/*!sc*/
data-styled.g1[id="sc-global-eVzEnO1"]{content:"sc-global-eVzEnO1,"}/*!sc*/
.iShFSJ{text-decoration:none;transition:color 0.2s ease;}/*!sc*/
data-styled.g2[id="styled-link__StyledLink-sc-1pzq7s8-0"]{content:"iShFSJ,"}/*!sc*/
.krcGPO{position:relative;display:flex;align-items:center;justify-content:center;background:transparent;border:none;cursor:pointer;padding:8px;width:40px;height:40px;border-radius:50%;transition:all 0.3s ease;}/*!sc*/
.krcGPO:hover{background:rgba(0, 0, 0, 0.05);}/*!sc*/
.krcGPO:focus{outline:none;}/*!sc*/
data-styled.g3[id="ThemeToggle__ToggleContainer-sc-r5oqsh-0"]{content:"krcGPO,"}/*!sc*/
.jbqbCh{width:20px;height:20px;fill:none;stroke:#555;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;transition:all 0.3s ease;}/*!sc*/
data-styled.g4[id="ThemeToggle__IconSVG-sc-r5oqsh-1"]{content:"jbqbCh,"}/*!sc*/
.kzFRDP{box-shadow:0 4px 12px 0 rgba(0,0,0,0.05);height:6rem;display:flex;align-items:center;justify-content:center;position:sticky;top:0;z-index:1000;background-color:#ffffff;transition:all 0.3s ease;}/*!sc*/
.kzFRDP.scrolled{box-shadow:0 4px 12px 0 rgba(0,0,0,0.1);}/*!sc*/
data-styled.g5[id="header__Container-sc-1hjyk8g-0"]{content:"kzFRDP,"}/*!sc*/
.ghlTEu{display:flex;align-items:center;width:100%;max-width:1300px;padding:0 2rem;position:relative;justify-content:center;}/*!sc*/
data-styled.g6[id="header__HeaderContent-sc-1hjyk8g-1"]{content:"ghlTEu,"}/*!sc*/
.cXVZur{font-size:1.6rem;font-weight:800;letter-spacing:0.1rem;text-transform:uppercase;margin:0;text-align:center;}/*!sc*/
@media (max-width:36em){.cXVZur{font-size:1.4rem;}}/*!sc*/
data-styled.g7[id="header__Title-sc-1hjyk8g-2"]{content:"cXVZur,"}/*!sc*/
.gLUYBn{position:absolute;right:2rem;top:50%;transform:translateY(-50%);}/*!sc*/
data-styled.g8[id="header__ThemeToggleWrapper-sc-1hjyk8g-3"]{content:"gLUYBn,"}/*!sc*/
.dcHxOC{margin:2rem 0;display:flex;flex-direction:column;gap:0.8rem;}/*!sc*/
data-styled.g9[id="tags__TagList-sc-1g5yckn-0"]{content:"dcHxOC,"}/*!sc*/
.lgsPVv{background:#f5f5f5;padding:0.7rem 1rem;border-radius:6px;color:#444;text-decoration:none;font-size:1.4rem;transition:all 0.2s;display:flex;justify-content:space-between;align-items:center;border:1px solid #eee;box-shadow:0 1px 3px rgba(0,0,0,0.05);}/*!sc*/
.lgsPVv:hover{background:#444;color:white;transform:translateY(-2px);box-shadow:0 3px 6px rgba(0,0,0,0.1);}/*!sc*/
data-styled.g10[id="tags__Tag-sc-1g5yckn-1"]{content:"lgsPVv,"}/*!sc*/
.cqHuIh{display:flex;align-items:center;gap:0.5rem;font-weight:500;}/*!sc*/
data-styled.g11[id="tags__TagName-sc-1g5yckn-2"]{content:"cqHuIh,"}/*!sc*/
.bKpJUB{font-size:1.2rem;}/*!sc*/
data-styled.g12[id="tags__TagIcon-sc-1g5yckn-3"]{content:"bKpJUB,"}/*!sc*/
.ikdXGw{background:rgba(0, 0, 0, 0.05);padding:0.3rem 0.7rem;border-radius:12px;font-size:1rem;color:#666;font-weight:500;}/*!sc*/
.tags__Tag-sc-1g5yckn-1:hover .ikdXGw{background:rgba(255,255,255,0.2);color:white;}/*!sc*/
data-styled.g13[id="tags__TagCount-sc-1g5yckn-4"]{content:"ikdXGw,"}/*!sc*/
.lcuDBI{margin:2rem 0;display:flex;flex-direction:column;gap:0.8rem;}/*!sc*/
data-styled.g14[id="search__SearchContainer-sc-i6vfcd-0"]{content:"lcuDBI,"}/*!sc*/
.jRfywj{display:flex;border-radius:6px;overflow:hidden;border:1px solid #eee;box-shadow:0 1px 3px rgba(0,0,0,0.05);transition:all 0.3s ease;}/*!sc*/
.jRfywj:focus-within{box-shadow:0 3px 6px rgba(0,0,0,0.1);transform:translateY(-2px);}/*!sc*/
data-styled.g15[id="search__SearchForm-sc-i6vfcd-1"]{content:"jRfywj,"}/*!sc*/
.bDpUex{flex:1;padding:0.7rem 1rem;border:none;background:#f5f5f5;font-size:1.4rem;outline:none;color:#444;font-weight:500;}/*!sc*/
.bDpUex::placeholder{color:#aaa;}/*!sc*/
@media (max-width:48em){.bDpUex{font-size:1.3rem;}}/*!sc*/
data-styled.g16[id="search__SearchInput-sc-i6vfcd-2"]{content:"bDpUex,"}/*!sc*/
.dsXcir{background:#444;color:white;border:none;padding:0 1.4rem;font-size:1.4rem;cursor:pointer;transition:all 0.2s ease;font-weight:500;min-width:50px;display:flex;align-items:center;justify-content:center;gap:5px;}/*!sc*/
.dsXcir:hover{background:#333;transform:translateX(2px);}/*!sc*/
.dsXcir svg{width:15px;height:15px;}/*!sc*/
data-styled.g17[id="search__SearchButton-sc-i6vfcd-3"]{content:"dsXcir,"}/*!sc*/
.lhUvbS{display:block;height:6rem;}/*!sc*/
data-styled.g18[id="layout__Footer-sc-wzore3-0"]{content:"lhUvbS,"}/*!sc*/
.hgiPss{margin-left:0;min-height:100vh;position:relative;background-color:#ffffff;transition:all 0.3s ease;}/*!sc*/
data-styled.g19[id="layout__MainContainer-sc-wzore3-1"]{content:"hgiPss,"}/*!sc*/
.EHWEE{display:flex;max-width:1300px;margin:0 auto;padding:0;gap:7rem;min-height:calc(100vh - 100px);}/*!sc*/
@media (max-width:48em){.EHWEE{flex-direction:column;min-height:auto;padding:0 1rem;}}/*!sc*/
data-styled.g20[id="layout__ContentWrapper-sc-wzore3-2"]{content:"EHWEE,"}/*!sc*/
.kIqrlx{width:220px;padding:2rem 0;position:sticky;top:50%;transform:translateY(-50%);height:fit-content;max-height:70vh;overflow-y:auto;margin-left:1rem;}/*!sc*/
@media (max-width:48em){.kIqrlx{width:100%;position:static;padding:1rem 0;transform:none;border-bottom:1px solid #eee;margin-bottom:1rem;max-height:none;margin-left:0;}}/*!sc*/
data-styled.g21[id="layout__TagsContainer-sc-wzore3-3"]{content:"kIqrlx,"}/*!sc*/
.bkKSq{flex:1;padding:2rem;max-width:800px;}/*!sc*/
@media (max-width:48em){.bkKSq{padding:1rem 0;}}/*!sc*/
data-styled.g22[id="layout__Content-sc-wzore3-4"]{content:"bkKSq,"}/*!sc*/
.jkJIRs{margin-top:8rem;}/*!sc*/
.jkJIRs img{width:100%;}/*!sc*/
@media (max-width:36em){.jkJIRs{margin-top:4rem;}}/*!sc*/
.jkJIRs p{line-height:1.5;}/*!sc*/
.jkJIRs blockquote{margin-left:0.25rem;font-size:1.6rem;color:inherit;font-style:italic;border-left:0.2rem solid rgb(0,0,0);padding-left:1rem;margin:1rem 0;}/*!sc*/
.jkJIRs pre{margin-bottom:2rem;}/*!sc*/
.jkJIRs h3{line-height:1.13;}/*!sc*/
.jkJIRs h2,.jkJIRs h3,.jkJIRs h4,.jkJIRs h5,.jkJIRs h6{margin:2rem 0 2rem;}/*!sc*/
.jkJIRs hr{border:0;border-top:0.1rem solid #ccc;display:block;height:1rem;padding:0;}/*!sc*/
data-styled.g23[id="post-styles__Container-sc-uvw59-0"]{content:"jkJIRs,"}/*!sc*/
@media (max-width:48em){.cerzGa{text-align:center;}}/*!sc*/
data-styled.g24[id="post-styles__Header-sc-uvw59-1"]{content:"cerzGa,"}/*!sc*/
.iyQHsV{margin-bottom:1rem;font-size:3rem;}/*!sc*/
data-styled.g25[id="post-styles__Title-sc-uvw59-2"]{content:"iyQHsV,"}/*!sc*/
.kserr{display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0px;}/*!sc*/
data-styled.g26[id="post-styles__LinkList-sc-uvw59-3"]{content:"kserr,"}/*!sc*/
.exQjBI{margin:1rem 0 5rem;}/*!sc*/
.exQjBI .social-icon{display:inline-block;margin:0 0.5rem;cursor:pointer;}/*!sc*/
data-styled.g27[id="share__Container-sc-1hk3kno-0"]{content:"exQjBI,"}/*!sc*/
.fqVogR{font-size:1.4rem;color:rgb(0,0,0);}/*!sc*/
data-styled.g28[id="share___StyledP-sc-1hk3kno-1"]{content:"fqVogR,"}/*!sc*/
.jLNYWx{color:rgba(0, 0, 0, 0.8);}/*!sc*/
data-styled.g29[id="sc-Qotzb"]{content:"jLNYWx,"}/*!sc*/
.cxHKfF{margin:5rem 0;}/*!sc*/
data-styled.g30[id="blog-post___StyledDiv-sc-1cxuom3-0"]{content:"cxHKfF,"}/*!sc*/
</style><link rel="icon" href="/favicon-32x32.png?v=5fa6e614f0c84651b75fe27d99928ac0" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=5fa6e614f0c84651b75fe27d99928ac0"/><link rel="sitemap" type="application/xml" href="/sitemap-index.xml"/><title data-gatsby-head="true">다중 가용 영역 클러스터에 Cluster Autoscaler 도입하기</title><link rel="icon" href="/favicon.ico" data-gatsby-head="true"/></head><body><noscript>Sorry! This site requires JavaScript to be enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><nav class="header__Container-sc-1hjyk8g-0 kzFRDP"><div class="header__HeaderContent-sc-1hjyk8g-1 ghlTEu"><a class="styled-link__StyledLink-sc-1pzq7s8-0 iShFSJ" href="/"><h1 class="header__Title-sc-1hjyk8g-2 cXVZur">zooneon&#x27;s log</h1></a><div class="header__ThemeToggleWrapper-sc-1hjyk8g-3 gLUYBn"><button aria-label="다크모드로 전환" title="다크모드로 전환" class="ThemeToggle__ToggleContainer-sc-r5oqsh-0 krcGPO"><svg viewBox="0 0 24 24" class="ThemeToggle__IconSVG-sc-r5oqsh-1 jbqbCh"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></button></div></div></nav><div class="layout__MainContainer-sc-wzore3-1 hgiPss"><div class="layout__ContentWrapper-sc-wzore3-2 EHWEE"><div class="layout__TagsContainer-sc-wzore3-3 kIqrlx"><div class="search__SearchContainer-sc-i6vfcd-0 lcuDBI"><form class="search__SearchForm-sc-i6vfcd-1 jRfywj"><input type="text" placeholder="블로그 검색..." aria-label="블로그 검색" class="search__SearchInput-sc-i6vfcd-2 bDpUex" value=""/><button type="submit" class="search__SearchButton-sc-i6vfcd-3 dsXcir"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></button></form></div><div class="tags__TagList-sc-1g5yckn-0 dcHxOC"><a class="tags__Tag-sc-1g5yckn-1 lgsPVv" href="/tags/aws/"><span class="tags__TagName-sc-1g5yckn-2 cqHuIh"><span class="tags__TagIcon-sc-1g5yckn-3 bKpJUB">#</span>aws</span><span class="tags__TagCount-sc-1g5yckn-4 ikdXGw">4<!-- -->개 글</span></a><a class="tags__Tag-sc-1g5yckn-1 lgsPVv" href="/tags/calico/"><span class="tags__TagName-sc-1g5yckn-2 cqHuIh"><span class="tags__TagIcon-sc-1g5yckn-3 bKpJUB">#</span>calico</span><span class="tags__TagCount-sc-1g5yckn-4 ikdXGw">1<!-- -->개 글</span></a><a class="tags__Tag-sc-1g5yckn-1 lgsPVv" href="/tags/cluster-autoscaler/"><span class="tags__TagName-sc-1g5yckn-2 cqHuIh"><span class="tags__TagIcon-sc-1g5yckn-3 bKpJUB">#</span>cluster-autoscaler</span><span class="tags__TagCount-sc-1g5yckn-4 ikdXGw">1<!-- -->개 글</span></a><a class="tags__Tag-sc-1g5yckn-1 lgsPVv" href="/tags/cni/"><span class="tags__TagName-sc-1g5yckn-2 cqHuIh"><span class="tags__TagIcon-sc-1g5yckn-3 bKpJUB">#</span>cni</span><span class="tags__TagCount-sc-1g5yckn-4 ikdXGw">1<!-- -->개 글</span></a><a class="tags__Tag-sc-1g5yckn-1 lgsPVv" href="/tags/ha/"><span class="tags__TagName-sc-1g5yckn-2 cqHuIh"><span class="tags__TagIcon-sc-1g5yckn-3 bKpJUB">#</span>ha</span><span class="tags__TagCount-sc-1g5yckn-4 ikdXGw">1<!-- -->개 글</span></a><a class="tags__Tag-sc-1g5yckn-1 lgsPVv" href="/tags/kubernetes/"><span class="tags__TagName-sc-1g5yckn-2 cqHuIh"><span class="tags__TagIcon-sc-1g5yckn-3 bKpJUB">#</span>kubernetes</span><span class="tags__TagCount-sc-1g5yckn-4 ikdXGw">6<!-- -->개 글</span></a></div></div><div class="layout__Content-sc-wzore3-4 bkKSq"><article class="post-styles__Container-sc-uvw59-0 jkJIRs"><header class="post-styles__Header-sc-uvw59-1 cerzGa"><h1 class="post-styles__Title-sc-uvw59-2 iyQHsV">다중 가용 영역 클러스터에 Cluster Autoscaler 도입하기</h1><sub class="sc-Qotzb jLNYWx"><span>Posted on <!-- -->December 26, 2022</span><span>  -  </span><span>28 min read</span></sub></header><div class="blog-post___StyledDiv-sc-1cxuom3-0 cxHKfF"><h3>개요</h3>
<p>고가용성을 위한 인프라 환경 제공이라는 주제로 프로젝트를 진행하면서 쿠버네티스 클러스터에 오토스케일러를 도입하였다.</p>
<p>먼저 <code class="language-text">HPA</code>를 이용하여 파드 스케일링이 가능하도록 하였지만, 노드에 리소스가 없을 경우 스케일 아웃된 파드가 스케줄되지 못하고 <code class="language-text">Pending</code> 상태에 남게 되는 문제가 발생하였다.</p>
<p>이를 해결하기 위해 <a href="https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler">Cluster Autoscaler</a>를 도입하였다.</p>
<p><code class="language-text">Cluster Autoscaler</code>에 대해 간단히 설명하자면 클러스터의 상태를 감시하고 있다가 필요한 경우 클라우드 프로바이더의 오토스케일링 서비스를 이용하여 노드 스케일링을 진행한다.</p>
<p><code class="language-text">Cluster Autoscaler</code>를 도입하기 앞서 어떻게 적용할지 결정해야 했다.</p>
<p>AWS 환경에서 고가용성을 위해 3개의 가용 영역(AZ)에 걸쳐 쿠버네티스 클러스터를 구축하였는데, 애플리케이션 배포 방법과 오토스케일링 그룹(ASG)를 어떻게 묶느냐에 따라 달랐다.</p>
<p>다음과 같이 총 4가지 방법을 생각하였다.</p>
<ul>
<li><code class="language-text">1 AutoScalingGroup</code> + <code class="language-text">1 Deployment</code></li>
<li><code class="language-text">1 AutoScalingGroup</code> + <code class="language-text">3 Deployment</code></li>
<li><code class="language-text">3 AutoScalingGroup</code> + <code class="language-text">1 Deployment</code></li>
<li><code class="language-text">3 AutoScalingGroup</code> + <code class="language-text">3 Deployment</code></li>
</ul>
<p>결론을 내리기 위해 각 방법에 따라 가설을 세우고 테스트를 통한 검증 과정이 필요했다.</p>
<h3>테스트 환경</h3>
<ul>
<li>kubernetes v1.21.1</li>
<li>Cluster Autoscaler v1.22.2</li>
<li>각 가용 영역에 2개의 worker 노드 배치(default)</li>
<li>원활한 테스트를 위해 파드 리소스 지정
<ul>
<li>현재 설정으로 하나의 노드에 최대 3개 파드 배포 가능</li>
</ul>
</li>
</ul>
<h3>가설 정의</h3>
<ul>
<li><code class="language-text">1 AutoScalingGroup</code> + <code class="language-text">1 Deployment</code>
<ul>
<li>1개의 배포를 수행하여 자동으로 각 가용 영역에 균등하게 배포 가능</li>
<li>하나의 배포만 관리</li>
<li>cluster autoscaler가 특정 가용 영역을 찾기 위한 오버헤드가 존재하지 않음</li>
</ul>
</li>
<li><code class="language-text">1 AutoScalingGroup</code> + <code class="language-text">3 Deployment</code>
<ul>
<li>3개의 배포를 수행하여 수동으로 각 가용 영역에 균등하게 배포 가능</li>
<li>3개의 배포를 관리해야 하므로 관리 포인트가 증가(hpa도 3개 관리해야 함)</li>
<li>cluster autoscaler가 모든 가용 영역을 포함하는 하나의 asg를 관리하므로 스케일이 필요한 특정 가용 영역을 찾기 위한 오버헤드가 발생
<ul>
<li>예) zone A에 스케일이 필요한 상태에서 cluster autoscaler는 zone A가 아닌 zone B 또는 zone C에 노드를 생성하여 파드 스케줄링이 지연됨</li>
</ul>
</li>
</ul>
</li>
<li><code class="language-text">3 AutoScalingGroup</code> + <code class="language-text">1 Deployment</code>
<ul>
<li>1개의 배포를 수행하여 자동으로 각 가용 영역에 균등하게 배포 가능</li>
<li>하나의 배포만 관리</li>
<li>특정 가용 영역이 다운됐을 경우 self healing을 통해 다른 노드그룹으로 마이그레이션 가능</li>
</ul>
</li>
<li><code class="language-text">3 AutoScalingGroup</code> + <code class="language-text">3 Deployment</code>
<ul>
<li>3개의 배포를 수행하여 수동으로 각 가용 영역에 균등하게 배포 가능</li>
<li>3개의 배포를 관리해야 하므로 관리 포인트가 증가(hpa도 3개 관리해야 함)</li>
<li>cluster autoscaler가 특정 가용 영역을 찾기 위한 오버헤드가 존재하지 않음</li>
<li>특정 가용 영역이 다운됐을 경우 self healing되지 않음</li>
</ul>
</li>
</ul>
<h3>가설 검증</h3>
<p><code class="language-text">1 AutoScalingGroup</code> + <code class="language-text">1 Deployment</code></p>
<p><img src="https://user-images.githubusercontent.com/59433441/209476487-f2750191-9fa0-4174-806b-6b5e989d25de.png" alt="1asg + 1deploy"></p>
<p>1개의 배포를 수행하여 자동으로 각 가용 영역에 균등하게 배포 가능<br>
각 가용 영역에 배포되도록 zone을 topology로 하는 <code class="language-text">soft pod anti affinity</code> 적용(<code class="language-text">hard affinity</code>를 적용할 경우 배포가 정상적으로 수행되지 않을 수도 있으므로)</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># nginx-deploy.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deploy
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">6</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>
          <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
              <span class="token key atrule">podAffinityTerm</span><span class="token punctuation">:</span>
                <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> topology.kubernets.io/zone
                <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>
                  <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
                    <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app
                      <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                      <span class="token key atrule">values</span><span class="token punctuation">:</span>
                        <span class="token punctuation">-</span> nginx
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">resources</span><span class="token punctuation">:</span>
            <span class="token key atrule">requests</span><span class="token punctuation">:</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">'500m'</span>
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">'256Mi'</span>
            <span class="token key atrule">limits</span><span class="token punctuation">:</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">'500m'</span>
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">'256Mi'</span>
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre></div>
<p>가용 영역마다 균등하게 배포된 것 확인</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k get po -o wide</span>
NAME                            READY   STATUS    RESTARTS   AGE   IP               NODE                                            NOMINATED NODE   READINESS GATES
nginx-deploy-55d455cb69-56zjd   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          13s   <span class="token number">192.168</span>.195.1    ip-10-0-5-174.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-55d455cb69-679xs   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          13s   <span class="token number">192.168</span>.150.65   ip-10-0-4-94.ap-northeast-2.compute.internal    <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-55d455cb69-9rc6w   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          13s   <span class="token number">192.168</span>.37.129   ip-10-0-4-89.ap-northeast-2.compute.internal    <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-55d455cb69-cxmz5   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          13s   <span class="token number">192.168</span>.95.65    ip-10-0-5-243.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-55d455cb69-fwgf9   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          13s   <span class="token number">192.168</span>.152.65   ip-10-0-3-169.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-55d455cb69-mddq2   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          13s   <span class="token number">192.168</span>.50.193   ip-10-0-3-203.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span></code></pre></div>
<p>하나의 배포만 관리
모든 가용 영역에 배포하기 위해 1개의 배포를 수행한다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k get deploy</span>
NAME           READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deploy   <span class="token number">6</span>/6     <span class="token number">6</span>            <span class="token number">6</span>           9m8s</code></pre></div>
<p>cluster autoscaler가 특정 가용 영역을 찾기 위한 오버헤드가 존재하지 않음
테스트를 위해 레플리카 수 조정</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k scale deploy nginx-deploy --replicas=21</span>
deployment.apps/nginx-deploy scaled</code></pre></div>
<p>파드를 스케줄링할 수 없자 cluster autoscaler가 이를 감지하고 스케일 아웃 진행</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k get po |grep Pending</span>
nginx-deploy-5975cd4c6f-khvm4   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          4s
nginx-deploy-5975cd4c6f-fzvs5   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          4s
nginx-deploy-5975cd4c6f-cr89p   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          4s</code></pre></div>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k logs cluster-autoscaler-5fc547f877-6btxr -n kube-system</span>
<span class="token punctuation">..</span>
I1223 <span class="token number">12</span>:28:45.755920       <span class="token number">1</span> waste.go:57<span class="token punctuation">]</span> Expanding Node Group terraform-20221223072925690300000012 would waste <span class="token number">25.00</span>% CPU, <span class="token number">80.12</span>% Memory, <span class="token number">52.56</span>% Blended
I1223 <span class="token number">12</span>:28:45.756018       <span class="token number">1</span> scale_up.go:468<span class="token punctuation">]</span> Best option to resize: terraform-20221223072925690300000012
I1223 <span class="token number">12</span>:28:45.756102       <span class="token number">1</span> scale_up.go:472<span class="token punctuation">]</span> Estimated <span class="token number">1</span> nodes needed <span class="token keyword">in</span> terraform-20221223072925690300000012
I1223 <span class="token number">12</span>:28:45.756171       <span class="token number">1</span> scale_up.go:586<span class="token punctuation">]</span> Final scale-up plan: <span class="token punctuation">[</span><span class="token punctuation">{</span>terraform-20221223072925690300000012 <span class="token number">6</span>-<span class="token operator">></span><span class="token number">7</span> <span class="token punctuation">(</span>max: <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
I1223 <span class="token number">12</span>:28:45.756242       <span class="token number">1</span> scale_up.go:675<span class="token punctuation">]</span> Scale-up: setting group terraform-20221223072925690300000012 size to <span class="token number">7</span>
I1223 <span class="token number">12</span>:28:45.756323       <span class="token number">1</span> auto_scaling_groups.go:219<span class="token punctuation">]</span> Setting asg terraform-20221223072925690300000012 size to <span class="token number">7</span>
I1223 <span class="token number">12</span>:28:45.756770       <span class="token number">1</span> event_sink_logging_wrapper.go:48<span class="token punctuation">]</span> Event<span class="token punctuation">(</span>v1.ObjectReference<span class="token punctuation">{</span>Kind:<span class="token string">"ConfigMap"</span>, Namespace:<span class="token string">"kube-system"</span>, Name:<span class="token string">"cluster-autoscaler-status"</span>, <span class="token environment constant">UID</span><span class="token builtin class-name">:</span><span class="token string">"4b58a55c-87b4-43a7-9894-5e469cc3690f"</span>, APIVersion:<span class="token string">"v1"</span>, ResourceVersion:<span class="token string">"55421"</span>, FieldPath:<span class="token string">""</span><span class="token punctuation">}</span><span class="token punctuation">)</span>: type: <span class="token string">'Normal'</span> reason: <span class="token string">'ScaledUpGroup'</span> Scale-up: setting group terraform-20221223072925690300000012 size to <span class="token number">7</span>
I1223 <span class="token number">12</span>:28:45.912416       <span class="token number">1</span> eventing_scale_up_processor.go:47<span class="token punctuation">]</span> Skipping event processing <span class="token keyword">for</span> unschedulable pods since there is a ScaleUp attempt this loop
I1223 <span class="token number">12</span>:28:45.912866       <span class="token number">1</span> event_sink_logging_wrapper.go:48<span class="token punctuation">]</span> Event<span class="token punctuation">(</span>v1.ObjectReference<span class="token punctuation">{</span>Kind:<span class="token string">"Pod"</span>, Namespace:<span class="token string">"default"</span>, Name:<span class="token string">"nginx-deploy-5975cd4c6f-khvm4"</span>, <span class="token environment constant">UID</span><span class="token builtin class-name">:</span><span class="token string">"aed89bd2-7f3c-4a04-938e-8af952582c65"</span>, APIVersion:<span class="token string">"v1"</span>, ResourceVersion:<span class="token string">"55405"</span>, FieldPath:<span class="token string">""</span><span class="token punctuation">}</span><span class="token punctuation">)</span>: type: <span class="token string">'Normal'</span> reason: <span class="token string">'TriggeredScaleUp'</span> pod triggered scale-up: <span class="token punctuation">[</span><span class="token punctuation">{</span>terraform-20221223072925690300000012 <span class="token number">6</span>-<span class="token operator">></span><span class="token number">7</span> <span class="token punctuation">(</span>max: <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
I1223 <span class="token number">12</span>:28:45.936356       <span class="token number">1</span> event_sink_logging_wrapper.go:48<span class="token punctuation">]</span> Event<span class="token punctuation">(</span>v1.ObjectReference<span class="token punctuation">{</span>Kind:<span class="token string">"Pod"</span>, Namespace:<span class="token string">"default"</span>, Name:<span class="token string">"nginx-deploy-5975cd4c6f-fzvs5"</span>, <span class="token environment constant">UID</span><span class="token builtin class-name">:</span><span class="token string">"59200ce3-668b-4a33-902b-cce3511d77bf"</span>, APIVersion:<span class="token string">"v1"</span>, ResourceVersion:<span class="token string">"55412"</span>, FieldPath:<span class="token string">""</span><span class="token punctuation">}</span><span class="token punctuation">)</span>: type: <span class="token string">'Normal'</span> reason: <span class="token string">'TriggeredScaleUp'</span> pod triggered scale-up: <span class="token punctuation">[</span><span class="token punctuation">{</span>terraform-20221223072925690300000012 <span class="token number">6</span>-<span class="token operator">></span><span class="token number">7</span> <span class="token punctuation">(</span>max: <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
I1223 <span class="token number">12</span>:28:45.966979       <span class="token number">1</span> event_sink_logging_wrapper.go:48<span class="token punctuation">]</span> Event<span class="token punctuation">(</span>v1.ObjectReference<span class="token punctuation">{</span>Kind:<span class="token string">"Pod"</span>, Namespace:<span class="token string">"default"</span>, Name:<span class="token string">"nginx-deploy-5975cd4c6f-cr89p"</span>, <span class="token environment constant">UID</span><span class="token builtin class-name">:</span><span class="token string">"743556f7-8ca7-4db3-8d20-ace37a1d2738"</span>, APIVersion:<span class="token string">"v1"</span>, ResourceVersion:<span class="token string">"55414"</span>, FieldPath:<span class="token string">""</span><span class="token punctuation">}</span><span class="token punctuation">)</span>: type: <span class="token string">'Normal'</span> reason: <span class="token string">'TriggeredScaleUp'</span> pod triggered scale-up: <span class="token punctuation">[</span><span class="token punctuation">{</span>terraform-20221223072925690300000012 <span class="token number">6</span>-<span class="token operator">></span><span class="token number">7</span> <span class="token punctuation">(</span>max: <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">..</span>
I1223 <span class="token number">12</span>:28:55.951121       <span class="token number">1</span> static_autoscaler.go:231<span class="token punctuation">]</span> Starting main loop
I1223 <span class="token number">12</span>:28:55.952023       <span class="token number">1</span> filter_out_schedulable.go:65<span class="token punctuation">]</span> Filtering out schedulables
I1223 <span class="token number">12</span>:28:55.952044       <span class="token number">1</span> filter_out_schedulable.go:132<span class="token punctuation">]</span> Filtered out <span class="token number">0</span> pods using hints
I1223 <span class="token number">12</span>:28:55.952190       <span class="token number">1</span> filter_out_schedulable.go:157<span class="token punctuation">]</span> Pod default.nginx-deploy-5975cd4c6f-khvm4 marked as unschedulable can be scheduled on <span class="token function">node</span> template-node-for-terraform-20221223072925690300000012-203101283895217702-upcoming-0. Ignoring <span class="token keyword">in</span> scale up.
I1223 <span class="token number">12</span>:28:55.952337       <span class="token number">1</span> filter_out_schedulable.go:157<span class="token punctuation">]</span> Pod default.nginx-deploy-5975cd4c6f-fzvs5 marked as unschedulable can be scheduled on <span class="token function">node</span> template-node-for-terraform-20221223072925690300000012-203101283895217702-upcoming-0. Ignoring <span class="token keyword">in</span> scale up.
I1223 <span class="token number">12</span>:28:55.952419       <span class="token number">1</span> filter_out_schedulable.go:157<span class="token punctuation">]</span> Pod default.nginx-deploy-5975cd4c6f-cr89p marked as unschedulable can be scheduled on <span class="token function">node</span> template-node-for-terraform-20221223072925690300000012-203101283895217702-upcoming-0. Ignoring <span class="token keyword">in</span> scale up.
I1223 <span class="token number">12</span>:28:55.952441       <span class="token number">1</span> filter_out_schedulable.go:170<span class="token punctuation">]</span> <span class="token number">0</span> pods were kept as unschedulable based on caching
I1223 <span class="token number">12</span>:28:55.952450       <span class="token number">1</span> filter_out_schedulable.go:171<span class="token punctuation">]</span> <span class="token number">3</span> pods marked as unschedulable can be scheduled.</code></pre></div>
<p>cluster autoscaler가 노드를 생성하여 파드가 정상적으로 스케줄링 됨</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k get no</span>
NAME                                            STATUS   ROLES                  AGE     VERSION
ip-10-0-3-100.ap-northeast-2.compute.internal   Ready    control-plane,master   4h59m   v1.21.1
ip-10-0-3-169.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 4h27m   v1.21.1
ip-10-0-3-203.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 4h29m   v1.21.1
ip-10-0-4-89.ap-northeast-2.compute.internal    Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 4h25m   v1.21.1
ip-10-0-4-94.ap-northeast-2.compute.internal    Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 4h25m   v1.21.1
ip-10-0-5-174.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 4h26m   v1.21.1
ip-10-0-5-190.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 117s    v1.21.1
ip-10-0-5-243.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 4h29m   v1.21.1</code></pre></div>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k get po</span>
NAME                            READY   STATUS    RESTARTS   AGE
nginx-deploy-5975cd4c6f-2mhkc   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14m
nginx-deploy-5975cd4c6f-85gwz   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14m
nginx-deploy-5975cd4c6f-8cgqw   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14m
nginx-deploy-5975cd4c6f-8rzwx   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14m
nginx-deploy-5975cd4c6f-cc4j9   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14m
nginx-deploy-5975cd4c6f-cr89p   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m47s
nginx-deploy-5975cd4c6f-f44qx   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14m
nginx-deploy-5975cd4c6f-fgh7p   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14m
nginx-deploy-5975cd4c6f-fhgrm   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14m
nginx-deploy-5975cd4c6f-fzvs5   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m47s
nginx-deploy-5975cd4c6f-g4dvn   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14m
nginx-deploy-5975cd4c6f-gn598   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14m
nginx-deploy-5975cd4c6f-gzvx5   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14m
nginx-deploy-5975cd4c6f-hckgt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14m
nginx-deploy-5975cd4c6f-hfggr   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14m
nginx-deploy-5975cd4c6f-hv5gt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14m
nginx-deploy-5975cd4c6f-jbbx4   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14m
nginx-deploy-5975cd4c6f-khvm4   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m47s
nginx-deploy-5975cd4c6f-mgxp8   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14m
nginx-deploy-5975cd4c6f-psxsl   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14m
nginx-deploy-5975cd4c6f-sl9hc   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14m</code></pre></div>
<p><code class="language-text">1 AutoScalingGroup</code> + <code class="language-text">3 Deployment</code></p>
<p><img src="https://user-images.githubusercontent.com/59433441/209476489-0a37fe55-4141-4096-9ba7-96b22a768836.png" alt="1asg + 3deploy">
3개의 배포를 수행하여 수동으로 각 가용 영역에 균등하게 배포 가능<br>
각 가용 영역에 배포되도록 zone을 topology로 하는 <code class="language-text">hard node affinity</code> 적용(해당 배포는 특정 영역에만 배포되어야 하기 때문에)</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># nginx-deploy-a.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deploy<span class="token punctuation">-</span>a
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
        <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span>
          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>
            <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> topology.kubernetes.io/zone
                    <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                    <span class="token key atrule">values</span><span class="token punctuation">:</span>
                      <span class="token punctuation">-</span> ap<span class="token punctuation">-</span>northeast<span class="token punctuation">-</span>2a
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">resources</span><span class="token punctuation">:</span>
            <span class="token key atrule">requests</span><span class="token punctuation">:</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">'500m'</span>
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">'256Mi'</span>
            <span class="token key atrule">limits</span><span class="token punctuation">:</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">'500m'</span>
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">'256Mi'</span>
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre></div>
<p>가용 영역마다 균등하게 배포된 것 확인</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k get po -o wide</span>
NAME                              READY   STATUS    RESTARTS   AGE   IP               NODE                                            NOMINATED NODE   READINESS GATES
nginx-deploy-a-5587c665fb-8ql7s   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          27s   <span class="token number">192.168</span>.50.196   ip-10-0-3-203.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-a-5587c665fb-hd7fq   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          24s   <span class="token number">192.168</span>.152.68   ip-10-0-3-169.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-b-58f74dd7b9-4sn6f   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21s   <span class="token number">192.168</span>.37.132   ip-10-0-4-89.ap-northeast-2.compute.internal    <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-b-58f74dd7b9-nqgsj   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          24s   <span class="token number">192.168</span>.150.68   ip-10-0-4-94.ap-northeast-2.compute.internal    <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-c-75764c77db-6ltk8   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          22s   <span class="token number">192.168</span>.95.68    ip-10-0-5-243.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-c-75764c77db-x62pt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          18s   <span class="token number">192.168</span>.195.4    ip-10-0-5-174.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span></code></pre></div>
<p>3개의 배포를 관리해야 하므로 관리 포인트가 증가
모든 가용 영역에 배포하기 위해 3개의 배포를 수행해야 한다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k get deploy</span>
NAME             READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deploy-a   <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           28m
nginx-deploy-b   <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           27m
nginx-deploy-c   <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           27m</code></pre></div>
<p>cluster autoscaler가 모든 가용 영역을 포함하는 하나의 asg를 관리하므로 스케일이 필요한 특정 가용 영역을 찾기 위한 오버헤드가 발생
테스트를 위해 zone C에 레플리카 수 조정</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k scale deploy nginx-deploy-c --replicas=9</span>
deployment.apps/nginx-deploy-c scaled</code></pre></div>
<p>파드를 스케줄링할 수 없자 cluster autoscaler가 이를 감지하고 스케일 아웃 진행</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k logs cluster-autoscaler-5fc547f877-6btxr -n kube-system</span>
<span class="token punctuation">..</span>
I1223 09:47:24.484810       <span class="token number">1</span> static_autoscaler.go:231<span class="token punctuation">]</span> Starting main loop
I1223 09:47:24.485570       <span class="token number">1</span> static_autoscaler.go:335<span class="token punctuation">]</span> <span class="token number">1</span> unregistered nodes present
I1223 09:47:24.485833       <span class="token number">1</span> filter_out_schedulable.go:65<span class="token punctuation">]</span> Filtering out schedulables
I1223 09:47:24.485966       <span class="token number">1</span> filter_out_schedulable.go:132<span class="token punctuation">]</span> Filtered out <span class="token number">0</span> pods using hints
I1223 09:47:24.486201       <span class="token number">1</span> filter_out_schedulable.go:170<span class="token punctuation">]</span> <span class="token number">0</span> pods were kept as unschedulable based on caching
I1223 09:47:24.486278       <span class="token number">1</span> filter_out_schedulable.go:171<span class="token punctuation">]</span> <span class="token number">0</span> pods marked as unschedulable can be scheduled.
I1223 09:47:24.486355       <span class="token number">1</span> filter_out_schedulable.go:82<span class="token punctuation">]</span> No schedulable pods
I1223 09:47:24.486417       <span class="token number">1</span> klogx.go:86<span class="token punctuation">]</span> Pod default/nginx-deploy-c-75764c77db-z9ccc is unschedulable
I1223 09:47:24.486482       <span class="token number">1</span> klogx.go:86<span class="token punctuation">]</span> Pod default/nginx-deploy-c-75764c77db-cq4b7 is unschedulable
I1223 09:47:24.486542       <span class="token number">1</span> klogx.go:86<span class="token punctuation">]</span> Pod default/nginx-deploy-c-75764c77db-z55mb is unschedulable
I1223 09:47:24.486691       <span class="token number">1</span> scale_up.go:376<span class="token punctuation">]</span> Upcoming <span class="token number">1</span> nodes
I1223 09:47:24.486843       <span class="token number">1</span> scale_up.go:300<span class="token punctuation">]</span> Pod nginx-deploy-c-75764c77db-z9ccc can<span class="token string">'t be scheduled on terraform-20221223072925690300000012, predicate checking error: node(s) didn'</span>t match Pod<span class="token string">'s node affinity/selector; predicateName=NodeAffinity; reasons: node(s) didn'</span>t match Pod<span class="token string">'s node affinity/selector; debugInfo=
I1223 09:47:24.486952       1 scale_up.go:300] Pod nginx-deploy-c-75764c77db-cq4b7 can'</span>t be scheduled on terraform-20221223072925690300000012, predicate checking error: node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> didn<span class="token string">'t match Pod'</span>s <span class="token function">node</span> affinity/selector<span class="token punctuation">;</span> <span class="token assign-left variable">predicateName</span><span class="token operator">=</span>NodeAffinity<span class="token punctuation">;</span> reasons: node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> didn<span class="token string">'t match Pod'</span>s <span class="token function">node</span> affinity/selector<span class="token punctuation">;</span> <span class="token assign-left variable">debugInfo</span><span class="token operator">=</span>
I1223 09:47:24.487035       <span class="token number">1</span> scale_up.go:300<span class="token punctuation">]</span> Pod nginx-deploy-c-75764c77db-z55mb can<span class="token string">'t be scheduled on terraform-20221223072925690300000012, predicate checking error: node(s) didn'</span>t match Pod<span class="token string">'s node affinity/selector; predicateName=NodeAffinity; reasons: node(s) didn'</span>t match Pod's <span class="token function">node</span> affinity/selector<span class="token punctuation">;</span> <span class="token assign-left variable">debugInfo</span><span class="token operator">=</span>
I1223 09:47:24.487101       <span class="token number">1</span> scale_up.go:449<span class="token punctuation">]</span> No pod can fit to terraform-20221223072925690300000012</code></pre></div>
<p>cluster autoscaler가 스케일링 했지만 zone C가 아닌 zone B에 노드를 생성하여 파드는 여전히 pending 상태</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k get no</span>
NAME                                            STATUS     ROLES                  AGE     VERSION
ip-10-0-3-100.ap-northeast-2.compute.internal   Ready      control-plane,master   135m    v1.21.1
ip-10-0-3-169.ap-northeast-2.compute.internal   Ready      <span class="token operator">&lt;</span>none<span class="token operator">></span>                 103m    v1.21.1
ip-10-0-3-203.ap-northeast-2.compute.internal   Ready      <span class="token operator">&lt;</span>none<span class="token operator">></span>                 105m    v1.21.1
ip-10-0-4-241.ap-northeast-2.compute.internal   Ready      <span class="token operator">&lt;</span>none<span class="token operator">></span>                 3m19s   v1.21.1
ip-10-0-4-89.ap-northeast-2.compute.internal    Ready      <span class="token operator">&lt;</span>none<span class="token operator">></span>                 101m    v1.21.1
ip-10-0-4-94.ap-northeast-2.compute.internal    Ready      <span class="token operator">&lt;</span>none<span class="token operator">></span>                 101m    v1.21.1
ip-10-0-5-174.ap-northeast-2.compute.internal   Ready      <span class="token operator">&lt;</span>none<span class="token operator">></span>                 103m    v1.21.1
ip-10-0-5-243.ap-northeast-2.compute.internal   Ready      <span class="token operator">&lt;</span>none<span class="token operator">></span>                 105m    v1.21.1</code></pre></div>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">root@ip-10-0-3-100:~<span class="token comment"># k get po |grep Pending</span>
NAME                              READY   STATUS    RESTARTS   AGE
nginx-deploy-c-75764c77db-cq4b7   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          4m31s
nginx-deploy-c-75764c77db-z55mb   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          4m31s
nginx-deploy-c-75764c77db-z9ccc   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          4m31s</code></pre></div>
<p>결국 cluster autoscaler가 노드를 하나 더 생성</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k get no</span>
NAME                                            STATUS   ROLES                  AGE     VERSION
ip-10-0-3-100.ap-northeast-2.compute.internal   Ready    control-plane,master   137m    v1.21.1
ip-10-0-3-169.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 105m    v1.21.1
ip-10-0-3-203.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 107m    v1.21.1
ip-10-0-4-241.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 5m39s   v1.21.1
ip-10-0-4-89.ap-northeast-2.compute.internal    Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 103m    v1.21.1
ip-10-0-4-94.ap-northeast-2.compute.internal    Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 103m    v1.21.1
ip-10-0-5-174.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 105m    v1.21.1
ip-10-0-5-243.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 107m    v1.21.1
ip-10-0-5-80.ap-northeast-2.compute.internal    Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 2m37s   v1.21.1</code></pre></div>
<p>이제서야 모든 파드가 스케줄링 됨</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k get po |grep nginx-deploy-c</span>
NAME                              READY   STATUS    RESTARTS   AGE
nginx-deploy-c-75764c77db-6ltk8   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          31m
nginx-deploy-c-75764c77db-bjn4n   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8m
nginx-deploy-c-75764c77db-cq4b7   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m31s
nginx-deploy-c-75764c77db-fb87j   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8m
nginx-deploy-c-75764c77db-nd7nz   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8m
nginx-deploy-c-75764c77db-pqwlt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8m
nginx-deploy-c-75764c77db-x62pt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          31m
nginx-deploy-c-75764c77db-z55mb   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m31s
nginx-deploy-c-75764c77db-z9ccc   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m31s</code></pre></div>
<p><code class="language-text">3 AutoScalingGroup</code> + <code class="language-text">1 Deployment</code></p>
<p><img src="https://user-images.githubusercontent.com/59433441/209476490-c08f69ce-95d6-46e8-9a42-a23ec44f63e9.png" alt="3asg + 1deploy"></p>
<p>1개의 배포를 수행하여 자동으로 각 가용 영역에 균등하게 배포 가능<br>
-> <code class="language-text">1 AutoScalingGroup</code> + <code class="language-text">1 Deployment</code> 방법과 같은 방식으로 배포</p>
<p>하나의 배포만 관리<br>
모든 가용 영역에 배포하기 위해 1개의 배포를 수행한다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k get deploy</span>
NAME           READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deploy   <span class="token number">6</span>/6     <span class="token number">6</span>            <span class="token number">6</span>           26s</code></pre></div>
<p>특정 가용 영역이 다운됐을 경우 self healing을 통해 다른 노드그룹으로 이동 가능
특정 가용 영역 다운(zone C에 설정한 asg 삭제)</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k get no</span>
NAME                                            STATUS   ROLES                  AGE     VERSION
ip-10-0-3-100.ap-northeast-2.compute.internal   Ready    control-plane,master   9h      v1.21.1
ip-10-0-3-116.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 25m     v1.21.1
ip-10-0-3-38.ap-northeast-2.compute.internal    Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 173m    v1.21.1
ip-10-0-4-142.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 14m     v1.21.1
ip-10-0-4-186.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 8m12s   v1.21.1</code></pre></div>
<p>해당 가용 영역에서 실행 중이던 노드가 다운되면서 파드가 self healing되고 노드에 리소스가 부족하여 pending 상태가 됨</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k get po -o wide</span>
NAME                            READY   STATUS    RESTARTS   AGE     IP                NODE                                            NOMINATED NODE   READINESS GATES
nginx-deploy-78d865fc9b-2wbft   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          5s      <span class="token operator">&lt;</span>none<span class="token operator">></span>            <span class="token operator">&lt;</span>none<span class="token operator">></span>                                          <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-57gsg   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m34s   <span class="token number">192.168</span>.60.205    ip-10-0-3-38.ap-northeast-2.compute.internal    <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-5nrrt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m37s   <span class="token number">192.168</span>.113.193   ip-10-0-4-142.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-7c7zw   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m34s   <span class="token number">192.168</span>.161.7     ip-10-0-3-116.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-cb8z5   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          5s      <span class="token operator">&lt;</span>none<span class="token operator">></span>            <span class="token operator">&lt;</span>none<span class="token operator">></span>                                          <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-dnp9k   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m34s   <span class="token number">192.168</span>.113.194   ip-10-0-4-142.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-gbhgv   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m37s   <span class="token number">192.168</span>.60.203    ip-10-0-3-38.ap-northeast-2.compute.internal    <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-kbg9j   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          4s      <span class="token operator">&lt;</span>none<span class="token operator">></span>            <span class="token operator">&lt;</span>none<span class="token operator">></span>                                          <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-kcgrn   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m34s   <span class="token number">192.168</span>.60.204    ip-10-0-3-38.ap-northeast-2.compute.internal    <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-l5nzg   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m37s   <span class="token number">192.168</span>.218.1     ip-10-0-4-186.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-lfsnz   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m34s   <span class="token number">192.168</span>.218.3     ip-10-0-4-186.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-m66r9   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m34s   <span class="token number">192.168</span>.218.2     ip-10-0-4-186.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-t4wmb   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m37s   <span class="token number">192.168</span>.161.5     ip-10-0-3-116.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-tnjpr   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m34s   <span class="token number">192.168</span>.113.195   ip-10-0-4-142.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-v8r87   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          5s      <span class="token operator">&lt;</span>none<span class="token operator">></span>            <span class="token operator">&lt;</span>none<span class="token operator">></span>                                          <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-wblfl   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          5s      <span class="token operator">&lt;</span>none<span class="token operator">></span>            <span class="token operator">&lt;</span>none<span class="token operator">></span>                                          <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-ww2rm   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m34s   <span class="token number">192.168</span>.161.6     ip-10-0-3-116.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-zvjmm   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          5s      <span class="token operator">&lt;</span>none<span class="token operator">></span>            <span class="token operator">&lt;</span>none<span class="token operator">></span>                                          <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span></code></pre></div>
<p>cluster autoscaler가 이를 감지하고 스케일 진행</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k logs cluster-autoscaler-5fc547f877-6btxr -n kube-system</span>
<span class="token punctuation">..</span>
I1223 <span class="token number">16</span>:40:56.706010       <span class="token number">1</span> filter_out_schedulable.go:157<span class="token punctuation">]</span> Pod default.nginx-deploy-78d865fc9b-v8r87 marked as unschedulable can be scheduled on <span class="token function">node</span> template-node-for-terraform-20221223072925690300000012-3178448486295206162-upcoming-0. Ignoring <span class="token keyword">in</span> scale up.
I1223 <span class="token number">16</span>:40:56.706288       <span class="token number">1</span> filter_out_schedulable.go:157<span class="token punctuation">]</span> Pod default.nginx-deploy-78d865fc9b-2wbft marked as unschedulable can be scheduled on <span class="token function">node</span> template-node-for-terraform-20221223072925690300000012-3178448486295206162-upcoming-0. Ignoring <span class="token keyword">in</span> scale up.
I1223 <span class="token number">16</span>:40:56.706359       <span class="token number">1</span> filter_out_schedulable.go:157<span class="token punctuation">]</span> Pod default.nginx-deploy-78d865fc9b-wblfl marked as unschedulable can be scheduled on <span class="token function">node</span> template-node-for-terraform-20221223072925690300000012-3178448486295206162-upcoming-0. Ignoring <span class="token keyword">in</span> scale up.
I1223 <span class="token number">16</span>:40:56.706607       <span class="token number">1</span> filter_out_schedulable.go:157<span class="token punctuation">]</span> Pod default.nginx-deploy-78d865fc9b-kbg9j marked as unschedulable can be scheduled on <span class="token function">node</span> template-node-for-terraform-20221223072925690300000012-3178448486295206162-upcoming-1. Ignoring <span class="token keyword">in</span> scale up.
I1223 <span class="token number">16</span>:40:56.706682       <span class="token number">1</span> filter_out_schedulable.go:157<span class="token punctuation">]</span> Pod default.nginx-deploy-78d865fc9b-zvjmm marked as unschedulable can be scheduled on <span class="token function">node</span> template-node-for-terraform-20221223072925690300000012-3178448486295206162-upcoming-1. Ignoring <span class="token keyword">in</span> scale up.
I1223 <span class="token number">16</span>:40:56.706901       <span class="token number">1</span> filter_out_schedulable.go:157<span class="token punctuation">]</span> Pod default.nginx-deploy-78d865fc9b-cb8z5 marked as unschedulable can be scheduled on <span class="token function">node</span> template-node-for-terraform-20221223072925690300000012-3178448486295206162-upcoming-1. Ignoring <span class="token keyword">in</span> scale up.
I1223 <span class="token number">16</span>:40:56.706930       <span class="token number">1</span> filter_out_schedulable.go:170<span class="token punctuation">]</span> <span class="token number">0</span> pods were kept as unschedulable based on caching
I1223 <span class="token number">16</span>:40:56.706940       <span class="token number">1</span> filter_out_schedulable.go:171<span class="token punctuation">]</span> <span class="token number">6</span> pods marked as unschedulable can be scheduled.</code></pre></div>
<p>cluster autoscaler가 노드를 생성하여 파드가 정상적으로 스케줄링 됨</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k get no</span>
NAME                                            STATUS   ROLES                  AGE    VERSION
ip-10-0-3-100.ap-northeast-2.compute.internal   Ready    control-plane,master   9h     v1.21.1
ip-10-0-3-111.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 2m     v1.21.1
ip-10-0-3-116.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 30m    v1.21.1
ip-10-0-3-160.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 2m     v1.21.1
ip-10-0-3-38.ap-northeast-2.compute.internal    Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 178m   v1.21.1
ip-10-0-4-142.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 18m    v1.21.1
ip-10-0-4-186.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 12m    v1.21.1</code></pre></div>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k get po -o wide</span>
NAME                            READY   STATUS    RESTARTS   AGE     IP                NODE                                            NOMINATED NODE   READINESS GATES
nginx-deploy-78d865fc9b-2wbft   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m29s   <span class="token number">192.168</span>.28.2      ip-10-0-3-111.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-57gsg   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6m58s   <span class="token number">192.168</span>.60.205    ip-10-0-3-38.ap-northeast-2.compute.internal    <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-5nrrt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12m     <span class="token number">192.168</span>.113.193   ip-10-0-4-142.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-7c7zw   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6m58s   <span class="token number">192.168</span>.161.7     ip-10-0-3-116.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-cb8z5   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m29s   <span class="token number">192.168</span>.28.3      ip-10-0-3-111.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-dnp9k   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6m58s   <span class="token number">192.168</span>.113.194   ip-10-0-4-142.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-gbhgv   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12m     <span class="token number">192.168</span>.60.203    ip-10-0-3-38.ap-northeast-2.compute.internal    <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-kbg9j   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m28s   <span class="token number">192.168</span>.52.2      ip-10-0-3-160.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-kcgrn   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6m58s   <span class="token number">192.168</span>.60.204    ip-10-0-3-38.ap-northeast-2.compute.internal    <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-l5nzg   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12m     <span class="token number">192.168</span>.218.1     ip-10-0-4-186.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-lfsnz   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6m58s   <span class="token number">192.168</span>.218.3     ip-10-0-4-186.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-m66r9   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6m58s   <span class="token number">192.168</span>.218.2     ip-10-0-4-186.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-t4wmb   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12m     <span class="token number">192.168</span>.161.5     ip-10-0-3-116.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-tnjpr   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6m58s   <span class="token number">192.168</span>.113.195   ip-10-0-4-142.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-v8r87   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m29s   <span class="token number">192.168</span>.52.3      ip-10-0-3-160.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-wblfl   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m29s   <span class="token number">192.168</span>.28.1      ip-10-0-3-111.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-ww2rm   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6m58s   <span class="token number">192.168</span>.161.6     ip-10-0-3-116.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-78d865fc9b-zvjmm   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m29s   <span class="token number">192.168</span>.52.1      ip-10-0-3-160.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span></code></pre></div>
<p>예상과 달리 zone A에 노드가 2개 생성됨
현재 zone A에는 노드가 4개, zone B에는 노드가 2개 존재</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k get no</span>
NAME                                            STATUS   ROLES                  AGE    VERSION
ip-10-0-3-100.ap-northeast-2.compute.internal   Ready    control-plane,master   9h     v1.21.1
ip-10-0-3-111.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 2m     v1.21.1
ip-10-0-3-116.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 30m    v1.21.1
ip-10-0-3-160.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 2m     v1.21.1
ip-10-0-3-38.ap-northeast-2.compute.internal    Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 178m   v1.21.1
ip-10-0-4-142.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 18m    v1.21.1
ip-10-0-4-186.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 12m    v1.21.1</code></pre></div>
<p><code class="language-text">--balance-similar-node-groups</code> 옵션을 이용하여 이를 해결 가능</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># cluster-autoscaler.yaml</span>
		<span class="token punctuation">...</span>
		<span class="token key atrule">spec</span><span class="token punctuation">:</span>
			<span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> k8s.gcr.io/autoscaling/cluster<span class="token punctuation">-</span>autoscaler<span class="token punctuation">:</span>v1.22.2
          <span class="token key atrule">name</span><span class="token punctuation">:</span> cluster<span class="token punctuation">-</span>autoscaler
          <span class="token key atrule">command</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> ./cluster<span class="token punctuation">-</span>autoscaler
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>v=4
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>stderrthreshold=info
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>cloud<span class="token punctuation">-</span>provider=aws
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>skip<span class="token punctuation">-</span>nodes<span class="token punctuation">-</span>with<span class="token punctuation">-</span>local<span class="token punctuation">-</span>storage=false
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>balance<span class="token punctuation">-</span>similar<span class="token punctuation">-</span>node<span class="token punctuation">-</span>groups  <span class="token comment"># 옵션 추가</span></code></pre></div>
<p>다시 테스트를 수행해보면 옵션이 적용되어 균형을 맞춰 노드가 생성되고 self healing 진행</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k logs cluster-autoscaler-5fbf84697-jlq6w -n kube-system</span>
<span class="token punctuation">..</span>
I1223 <span class="token number">17</span>:02:11.289518       <span class="token number">1</span> filter_out_schedulable.go:157<span class="token punctuation">]</span> Pod default.nginx-deploy-78d865fc9b-q4s72 marked as unschedulable can be scheduled on <span class="token function">node</span> template-node-for-terraform-20221223072925690300000012-6177026811335423860-upcoming-0. Ignoring <span class="token keyword">in</span> scale up.
I1223 <span class="token number">17</span>:02:11.289639       <span class="token number">1</span> filter_out_schedulable.go:157<span class="token punctuation">]</span> Pod default.nginx-deploy-78d865fc9b-58ch8 marked as unschedulable can be scheduled on <span class="token function">node</span> template-node-for-terraform-20221223072925690300000012-6177026811335423860-upcoming-0. Ignoring <span class="token keyword">in</span> scale up.
I1223 <span class="token number">17</span>:02:11.289775       <span class="token number">1</span> filter_out_schedulable.go:157<span class="token punctuation">]</span> Pod default.nginx-deploy-78d865fc9b-jh65t marked as unschedulable can be scheduled on <span class="token function">node</span> template-node-for-terraform-20221223072925690300000012-6177026811335423860-upcoming-0. Ignoring <span class="token keyword">in</span> scale up.
I1223 <span class="token number">17</span>:02:11.289915       <span class="token number">1</span> filter_out_schedulable.go:157<span class="token punctuation">]</span> Pod default.nginx-deploy-78d865fc9b-s8gjh marked as unschedulable can be scheduled on <span class="token function">node</span> template-node-for-terraform-20221223072925690300000013-7979830878773245174-upcoming-0. Ignoring <span class="token keyword">in</span> scale up.
I1223 <span class="token number">17</span>:02:11.290011       <span class="token number">1</span> filter_out_schedulable.go:157<span class="token punctuation">]</span> Pod default.nginx-deploy-78d865fc9b-l8dl4 marked as unschedulable can be scheduled on <span class="token function">node</span> template-node-for-terraform-20221223072925690300000013-7979830878773245174-upcoming-0. Ignoring <span class="token keyword">in</span> scale up.
I1223 <span class="token number">17</span>:02:11.290110       <span class="token number">1</span> filter_out_schedulable.go:157<span class="token punctuation">]</span> Pod default.nginx-deploy-78d865fc9b-m6vxq marked as unschedulable can be scheduled on <span class="token function">node</span> template-node-for-terraform-20221223072925690300000013-7979830878773245174-upcoming-0. Ignoring <span class="token keyword">in</span> scale up.
I1223 <span class="token number">17</span>:02:11.290158       <span class="token number">1</span> filter_out_schedulable.go:170<span class="token punctuation">]</span> <span class="token number">0</span> pods were kept as unschedulable based on caching
I1223 <span class="token number">17</span>:02:11.290169       <span class="token number">1</span> filter_out_schedulable.go:171<span class="token punctuation">]</span> <span class="token number">6</span> pods marked as unschedulable can be scheduled.</code></pre></div>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k get no</span>
NAME                                            STATUS   ROLES                  AGE     VERSION
ip-10-0-3-100.ap-northeast-2.compute.internal   Ready    control-plane,master   9h      v1.21.1
ip-10-0-3-111.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 22m     v1.21.1
ip-10-0-3-125.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 2m39s   v1.21.1
ip-10-0-3-38.ap-northeast-2.compute.internal    Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 3h18m   v1.21.1
ip-10-0-4-133.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 2m53s   v1.21.1
ip-10-0-4-142.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 39m     v1.21.1
ip-10-0-4-186.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 33m     v1.21.1</code></pre></div>
<p>스케일 아웃도 <code class="language-text">--balance-similar-node-groups</code> 옵션이 존재하지 않으면 특정 가용 영역에만 노드가 생성됨</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k logs cluster-autoscaler-5fc547f877-n4sjr -n kube-system</span>
<span class="token punctuation">..</span>
<span class="token comment"># 현재 expander 옵션으로 least-waste 사용</span>
I1223 <span class="token number">17</span>:13:41.549539       <span class="token number">1</span> waste.go:57<span class="token punctuation">]</span> Expanding Node Group terraform-20221223072925690300000012 would waste <span class="token number">25.00</span>% CPU, <span class="token number">80.12</span>% Memory, <span class="token number">52.56</span>% Blended
I1223 <span class="token number">17</span>:13:41.549562       <span class="token number">1</span> waste.go:57<span class="token punctuation">]</span> Expanding Node Group terraform-20221223072925690300000013 would waste <span class="token number">25.00</span>% CPU, <span class="token number">80.12</span>% Memory, <span class="token number">52.56</span>% Blended
I1223 <span class="token number">17</span>:13:41.549576       <span class="token number">1</span> scale_up.go:468<span class="token punctuation">]</span> Best option to resize: terraform-20221223072925690300000013
I1223 <span class="token number">17</span>:13:41.549586       <span class="token number">1</span> scale_up.go:472<span class="token punctuation">]</span> Estimated <span class="token number">2</span> nodes needed <span class="token keyword">in</span> terraform-20221223072925690300000013
I1223 <span class="token number">17</span>:13:41.549608       <span class="token number">1</span> scale_up.go:586<span class="token punctuation">]</span> Final scale-up plan: <span class="token punctuation">[</span><span class="token punctuation">{</span>terraform-20221223072925690300000013 <span class="token number">2</span>-<span class="token operator">></span><span class="token number">4</span> <span class="token punctuation">(</span>max: <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
I1223 <span class="token number">17</span>:13:41.549634       <span class="token number">1</span> scale_up.go:675<span class="token punctuation">]</span> Scale-up: setting group terraform-20221223072925690300000013 size to <span class="token number">4</span>
I1223 <span class="token number">17</span>:13:41.549665       <span class="token number">1</span> auto_scaling_groups.go:219<span class="token punctuation">]</span> Setting asg terraform-20221223072925690300000013 size to <span class="token number">4</span></code></pre></div>
<p>마찬가지로 <code class="language-text">--balance-similar-node-groups</code> 옵션 적용 후 균형을 맞춰 스케일 아웃 진행</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k logs cluster-autoscaler-5fbf84697-pkx9r -n kub</span>
<span class="token punctuation">..</span>
<span class="token comment"># 현재 expander 옵션으로 least-waste 사용</span>
I1223 <span class="token number">17</span>:29:42.923429       <span class="token number">1</span> waste.go:57<span class="token punctuation">]</span> Expanding Node Group terraform-20221223072925690300000013 would waste <span class="token number">25.00</span>% CPU, <span class="token number">80.12</span>% Memory, <span class="token number">52.56</span>% Blended
I1223 <span class="token number">17</span>:29:42.923564       <span class="token number">1</span> waste.go:57<span class="token punctuation">]</span> Expanding Node Group terraform-20221223072925690300000012 would waste <span class="token number">25.00</span>% CPU, <span class="token number">80.12</span>% Memory, <span class="token number">52.56</span>% Blended
I1223 <span class="token number">17</span>:29:42.923639       <span class="token number">1</span> scale_up.go:468<span class="token punctuation">]</span> Best option to resize: terraform-20221223072925690300000013
I1223 <span class="token number">17</span>:29:42.923699       <span class="token number">1</span> scale_up.go:472<span class="token punctuation">]</span> Estimated <span class="token number">2</span> nodes needed <span class="token keyword">in</span> terraform-20221223072925690300000013
I1223 <span class="token number">17</span>:29:42.923806       <span class="token number">1</span> scale_up.go:578<span class="token punctuation">]</span> Splitting scale-up between <span class="token number">2</span> similar <span class="token function">node</span> groups: <span class="token punctuation">{</span>terraform-20221223072925690300000013, terraform-20221223072925690300000012<span class="token punctuation">}</span>
I1223 <span class="token number">17</span>:29:42.923885       <span class="token number">1</span> scale_up.go:586<span class="token punctuation">]</span> Final scale-up plan: <span class="token punctuation">[</span><span class="token punctuation">{</span>terraform-20221223072925690300000013 <span class="token number">2</span>-<span class="token operator">></span><span class="token number">3</span> <span class="token punctuation">(</span>max: <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>terraform-20221223072925690300000012 <span class="token number">2</span>-<span class="token operator">></span><span class="token number">3</span> <span class="token punctuation">(</span>max: <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
I1223 <span class="token number">17</span>:29:42.923947       <span class="token number">1</span> scale_up.go:675<span class="token punctuation">]</span> Scale-up: setting group terraform-20221223072925690300000013 size to <span class="token number">3</span>
I1223 <span class="token number">17</span>:29:42.924047       <span class="token number">1</span> auto_scaling_groups.go:219<span class="token punctuation">]</span> Setting asg terraform-20221223072925690300000013 size to <span class="token number">3</span></code></pre></div>
<p>공식문서에 따르면 <code class="language-text">--balance-similar-node-groups</code> 옵션을 이용하여 topolgy scheduling 없이도 node group의 균형을 맞추는 것이 가능하다고 함</p>
<p><code class="language-text">3 AutoScalingGroup</code> + <code class="language-text">3 Deployment</code></p>
<p><img src="https://user-images.githubusercontent.com/59433441/209476491-4db1fca8-8330-4101-849e-7acb4f53404c.png" alt="3asg + 3deploy"></p>
<p>3개의 배포를 수행하여 수동으로 각 가용 영역에 균등하게 배포 가능<br>
-> <code class="language-text">1 AutoScalingGroup</code> + <code class="language-text">3 Deployment</code> 방법과 같은 방식으로 배포</p>
<p>3개의 배포를 관리해야 하므로 관리 포인트가 증가(hpa도 3개 관리해야 함)</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k get deploy</span>
NAME             READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deploy-a   <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           44s
nginx-deploy-b   <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           42s
nginx-deploy-c   <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           38s</code></pre></div>
<p>cluster autoscaler가 특정 가용 영역을 찾기 위한 오버헤드가 존재하지 않음<br>
위의 <code class="language-text">1 AutoScalingGroup</code> + <code class="language-text">3 Deployment</code>와 달리 개별 asg를 갖고 있으므로 cluster autoscaler가 스케일 아웃을 여러번 시도하지 않아도 됨<br>
테스트를 위해 zone B에 레플리카 수 조정</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k scale deploy nginx-deploy-b --replicas=9</span>
deployment.apps/nginx-deploy-b scaled</code></pre></div>
<p>개별 배포를 수행했으므로 <code class="language-text">--balance-similar-node-groups</code> 옵션이 없어도 됨</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k logs cluster-autoscaler-5fbf84697-pkx9r -n kube-system</span>
<span class="token punctuation">..</span>
I1223 <span class="token number">17</span>:44:57.343385       <span class="token number">1</span> klogx.go:86<span class="token punctuation">]</span> Pod default/nginx-deploy-b-58f74dd7b9-8jbzx is unschedulable
I1223 <span class="token number">17</span>:44:57.343391       <span class="token number">1</span> klogx.go:86<span class="token punctuation">]</span> Pod default/nginx-deploy-b-58f74dd7b9-lcvw5 is unschedulable
I1223 <span class="token number">17</span>:44:57.343397       <span class="token number">1</span> klogx.go:86<span class="token punctuation">]</span> Pod default/nginx-deploy-b-58f74dd7b9-gfvxm is unschedulable
I1223 <span class="token number">17</span>:44:57.343449       <span class="token number">1</span> scale_up.go:376<span class="token punctuation">]</span> Upcoming <span class="token number">0</span> nodes
<span class="token comment"># 먼저 zone A에 스케일이 가능한지 검사하지만 node affinity 설정으로 인해 스케줄링 될 수 없음</span>
I1223 <span class="token number">17</span>:44:57.343533       <span class="token number">1</span> scale_up.go:300<span class="token punctuation">]</span> Pod nginx-deploy-b-58f74dd7b9-gfvxm can<span class="token string">'t be scheduled on terraform-20221223072925690300000012, predicate checking error: node(s) didn'</span>t match Pod<span class="token string">'s node affinity/selector; predicateName=NodeAffinity; reasons: node(s) didn'</span>t match Pod<span class="token string">'s node affinity/selector; debugInfo=
I1223 17:44:57.343556       1 scale_up.go:300] Pod nginx-deploy-b-58f74dd7b9-8jbzx can'</span>t be scheduled on terraform-20221223072925690300000012, predicate checking error: node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> didn<span class="token string">'t match Pod'</span>s <span class="token function">node</span> affinity/selector<span class="token punctuation">;</span> <span class="token assign-left variable">predicateName</span><span class="token operator">=</span>NodeAffinity<span class="token punctuation">;</span> reasons: node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> didn<span class="token string">'t match Pod'</span>s <span class="token function">node</span> affinity/selector<span class="token punctuation">;</span> <span class="token assign-left variable">debugInfo</span><span class="token operator">=</span>
I1223 <span class="token number">17</span>:44:57.343581       <span class="token number">1</span> scale_up.go:300<span class="token punctuation">]</span> Pod nginx-deploy-b-58f74dd7b9-lcvw5 can<span class="token string">'t be scheduled on terraform-20221223072925690300000012, predicate checking error: node(s) didn'</span>t match Pod<span class="token string">'s node affinity/selector; predicateName=NodeAffinity; reasons: node(s) didn'</span>t match Pod's <span class="token function">node</span> affinity/selector<span class="token punctuation">;</span> <span class="token assign-left variable">debugInfo</span><span class="token operator">=</span>
I1223 <span class="token number">17</span>:44:57.343605       <span class="token number">1</span> scale_up.go:449<span class="token punctuation">]</span> No pod can fit to terraform-20221223072925690300000012
<span class="token comment"># 현재 expander 옵션으로 least-waste 사용</span>
I1223 <span class="token number">17</span>:44:57.343843       <span class="token number">1</span> waste.go:57<span class="token punctuation">]</span> Expanding Node Group terraform-20221223072925690300000013 would waste <span class="token number">25.00</span>% CPU, <span class="token number">80.12</span>% Memory, <span class="token number">52.56</span>% Blended
I1223 <span class="token number">17</span>:44:57.343871       <span class="token number">1</span> scale_up.go:468<span class="token punctuation">]</span> Best option to resize: terraform-20221223072925690300000013
I1223 <span class="token number">17</span>:44:57.343882       <span class="token number">1</span> scale_up.go:472<span class="token punctuation">]</span> Estimated <span class="token number">1</span> nodes needed <span class="token keyword">in</span> terraform-20221223072925690300000013
I1223 <span class="token number">17</span>:44:57.343934       <span class="token number">1</span> scale_up.go:655<span class="token punctuation">]</span> No info about pods passing predicates found <span class="token keyword">for</span> group terraform-20221223072925690300000012, skipping it from scale-up consideration
<span class="token comment"># zone B에 스케일 아웃 진행</span>
I1223 <span class="token number">17</span>:44:57.343948       <span class="token number">1</span> scale_up.go:586<span class="token punctuation">]</span> Final scale-up plan: <span class="token punctuation">[</span><span class="token punctuation">{</span>terraform-20221223072925690300000013 <span class="token number">2</span>-<span class="token operator">></span><span class="token number">3</span> <span class="token punctuation">(</span>max: <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
I1223 <span class="token number">17</span>:44:57.343963       <span class="token number">1</span> scale_up.go:675<span class="token punctuation">]</span> Scale-up: setting group terraform-20221223072925690300000013 size to <span class="token number">3</span>
I1223 <span class="token number">17</span>:44:57.344167       <span class="token number">1</span> auto_scaling_groups.go:219<span class="token punctuation">]</span> Setting asg terraform-20221223072925690300000013 size to <span class="token number">3</span></code></pre></div>
<p>특정 가용 영역이 다운됐을 경우 self healing되지 않음
특정 가용 영역 다운(zone B에 설정한 asg 삭제)</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k get no</span>
NAME                                            STATUS   ROLES                  AGE   VERSION
ip-10-0-3-100.ap-northeast-2.compute.internal   Ready    control-plane,master   10h   v1.21.1
ip-10-0-3-125.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 55m   v1.21.1
ip-10-0-3-143.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 25m   v1.21.1
ip-10-0-5-106.ap-northeast-2.compute.internal   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 46m   v1.21.1
ip-10-0-5-9.ap-northeast-2.compute.internal     Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 46m   v1.21.1</code></pre></div>
<p>해당 가용 영역에서 실행 중이던 노드가 다운되면서 self healing을 시도하지만 개별 배포를 진행했으므로 마이그레이션 되지 않음</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k get po -o wide</span>
NAME                              READY   STATUS    RESTARTS   AGE     IP                NODE                                            NOMINATED NODE   READINESS GATES
nginx-deploy-a-5587c665fb-dsqhj   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          9m25s   <span class="token number">192.168</span>.157.205   ip-10-0-3-125.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-a-5587c665fb-gnltb   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          9m25s   <span class="token number">192.168</span>.157.206   ip-10-0-3-125.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-a-5587c665fb-gtj9w   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          9m25s   <span class="token number">192.168</span>.144.69    ip-10-0-3-143.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-a-5587c665fb-l9kz9   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21m     <span class="token number">192.168</span>.157.204   ip-10-0-3-125.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-a-5587c665fb-pmcmk   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21m     <span class="token number">192.168</span>.144.68    ip-10-0-3-143.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-a-5587c665fb-t22n6   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          9m25s   <span class="token number">192.168</span>.144.70    ip-10-0-3-143.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-b-58f74dd7b9-75s8l   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          27s     <span class="token operator">&lt;</span>none<span class="token operator">></span>            <span class="token operator">&lt;</span>none<span class="token operator">></span>                                          <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-b-58f74dd7b9-9hzvt   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          27s     <span class="token operator">&lt;</span>none<span class="token operator">></span>            <span class="token operator">&lt;</span>none<span class="token operator">></span>                                          <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-b-58f74dd7b9-dgmq9   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          27s     <span class="token operator">&lt;</span>none<span class="token operator">></span>            <span class="token operator">&lt;</span>none<span class="token operator">></span>                                          <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-b-58f74dd7b9-m6v42   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          47s     <span class="token operator">&lt;</span>none<span class="token operator">></span>            <span class="token operator">&lt;</span>none<span class="token operator">></span>                                          <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-b-58f74dd7b9-pqcpm   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          47s     <span class="token operator">&lt;</span>none<span class="token operator">></span>            <span class="token operator">&lt;</span>none<span class="token operator">></span>                                          <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-b-58f74dd7b9-qk5rs   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          47s     <span class="token operator">&lt;</span>none<span class="token operator">></span>            <span class="token operator">&lt;</span>none<span class="token operator">></span>                                          <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-c-75764c77db-67vnw   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          9m22s   <span class="token number">192.168</span>.199.140   ip-10-0-5-9.ap-northeast-2.compute.internal     <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-c-75764c77db-8zh45   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          9m22s   <span class="token number">192.168</span>.77.139    ip-10-0-5-106.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-c-75764c77db-bcdcd   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          9m23s   <span class="token number">192.168</span>.77.138    ip-10-0-5-106.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-c-75764c77db-fz4zq   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          9m22s   <span class="token number">192.168</span>.199.139   ip-10-0-5-9.ap-northeast-2.compute.internal     <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-c-75764c77db-lc9z2   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21m     <span class="token number">192.168</span>.199.138   ip-10-0-5-9.ap-northeast-2.compute.internal     <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-deploy-c-75764c77db-slwwm   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21m     <span class="token number">192.168</span>.77.137    ip-10-0-5-106.ap-northeast-2.compute.internal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span></code></pre></div>
<p>cluster autoscaler도 스케일 아웃 가능한 asg를 찾을 수 없음(상태 유지)</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># k logs cluster-autoscaler-5fbf84697-pkx9r -n kube-system</span>
<span class="token punctuation">..</span>
I1223 <span class="token number">18</span>:01:31.932937       <span class="token number">1</span> scale_up.go:300<span class="token punctuation">]</span> Pod nginx-deploy-b-58f74dd7b9-m6v42 can<span class="token string">'t be scheduled on terraform-20221223072925690300000012, predicate checking error: node(s) didn'</span>t match Pod<span class="token string">'s node affinity/selector; predicateName=NodeAffinity; reasons: node(s) didn'</span>t match Pod<span class="token string">'s node affinity/selector; debugInfo=
I1223 18:01:31.933117       1 scale_up.go:300] Pod nginx-deploy-b-58f74dd7b9-qk5rs can'</span>t be scheduled on terraform-20221223072925690300000012, predicate checking error: node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> didn<span class="token string">'t match Pod'</span>s <span class="token function">node</span> affinity/selector<span class="token punctuation">;</span> <span class="token assign-left variable">predicateName</span><span class="token operator">=</span>NodeAffinity<span class="token punctuation">;</span> reasons: node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> didn<span class="token string">'t match Pod'</span>s <span class="token function">node</span> affinity/selector<span class="token punctuation">;</span> <span class="token assign-left variable">debugInfo</span><span class="token operator">=</span>
I1223 <span class="token number">18</span>:01:31.933202       <span class="token number">1</span> scale_up.go:300<span class="token punctuation">]</span> Pod nginx-deploy-b-58f74dd7b9-pqcpm can<span class="token string">'t be scheduled on terraform-20221223072925690300000012, predicate checking error: node(s) didn'</span>t match Pod<span class="token string">'s node affinity/selector; predicateName=NodeAffinity; reasons: node(s) didn'</span>t match Pod<span class="token string">'s node affinity/selector; debugInfo=
I1223 18:01:31.933325       1 scale_up.go:300] Pod nginx-deploy-b-58f74dd7b9-9hzvt can'</span>t be scheduled on terraform-20221223072925690300000012, predicate checking error: node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> didn<span class="token string">'t match Pod'</span>s <span class="token function">node</span> affinity/selector<span class="token punctuation">;</span> <span class="token assign-left variable">predicateName</span><span class="token operator">=</span>NodeAffinity<span class="token punctuation">;</span> reasons: node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> didn<span class="token string">'t match Pod'</span>s <span class="token function">node</span> affinity/selector<span class="token punctuation">;</span> <span class="token assign-left variable">debugInfo</span><span class="token operator">=</span>
I1223 <span class="token number">18</span>:01:31.933418       <span class="token number">1</span> scale_up.go:300<span class="token punctuation">]</span> Pod nginx-deploy-b-58f74dd7b9-75s8l can<span class="token string">'t be scheduled on terraform-20221223072925690300000012, predicate checking error: node(s) didn'</span>t match Pod<span class="token string">'s node affinity/selector; predicateName=NodeAffinity; reasons: node(s) didn'</span>t match Pod<span class="token string">'s node affinity/selector; debugInfo=
I1223 18:01:31.933499       1 scale_up.go:300] Pod nginx-deploy-b-58f74dd7b9-dgmq9 can'</span>t be scheduled on terraform-20221223072925690300000012, predicate checking error: node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> didn<span class="token string">'t match Pod'</span>s <span class="token function">node</span> affinity/selector<span class="token punctuation">;</span> <span class="token assign-left variable">predicateName</span><span class="token operator">=</span>NodeAffinity<span class="token punctuation">;</span> reasons: node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> didn<span class="token string">'t match Pod'</span>s <span class="token function">node</span> affinity/selector<span class="token punctuation">;</span> <span class="token assign-left variable">debugInfo</span><span class="token operator">=</span>
I1223 <span class="token number">18</span>:01:31.933593       <span class="token number">1</span> scale_up.go:449<span class="token punctuation">]</span> No pod can fit to terraform-20221223072925690300000012
I1223 <span class="token number">18</span>:01:31.933755       <span class="token number">1</span> scale_up.go:300<span class="token punctuation">]</span> Pod nginx-deploy-b-58f74dd7b9-m6v42 can<span class="token string">'t be scheduled on terraform-20221223072925690300000014, predicate checking error: node(s) didn'</span>t match Pod<span class="token string">'s node affinity/selector; predicateName=NodeAffinity; reasons: node(s) didn'</span>t match Pod<span class="token string">'s node affinity/selector; debugInfo=
I1223 18:01:31.933854       1 scale_up.go:300] Pod nginx-deploy-b-58f74dd7b9-qk5rs can'</span>t be scheduled on terraform-20221223072925690300000014, predicate checking error: node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> didn<span class="token string">'t match Pod'</span>s <span class="token function">node</span> affinity/selector<span class="token punctuation">;</span> <span class="token assign-left variable">predicateName</span><span class="token operator">=</span>NodeAffinity<span class="token punctuation">;</span> reasons: node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> didn<span class="token string">'t match Pod'</span>s <span class="token function">node</span> affinity/selector<span class="token punctuation">;</span> <span class="token assign-left variable">debugInfo</span><span class="token operator">=</span>
I1223 <span class="token number">18</span>:01:31.933945       <span class="token number">1</span> scale_up.go:300<span class="token punctuation">]</span> Pod nginx-deploy-b-58f74dd7b9-pqcpm can<span class="token string">'t be scheduled on terraform-20221223072925690300000014, predicate checking error: node(s) didn'</span>t match Pod<span class="token string">'s node affinity/selector; predicateName=NodeAffinity; reasons: node(s) didn'</span>t match Pod<span class="token string">'s node affinity/selector; debugInfo=
I1223 18:01:31.934034       1 scale_up.go:300] Pod nginx-deploy-b-58f74dd7b9-9hzvt can'</span>t be scheduled on terraform-20221223072925690300000014, predicate checking error: node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> didn<span class="token string">'t match Pod'</span>s <span class="token function">node</span> affinity/selector<span class="token punctuation">;</span> <span class="token assign-left variable">predicateName</span><span class="token operator">=</span>NodeAffinity<span class="token punctuation">;</span> reasons: node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> didn<span class="token string">'t match Pod'</span>s <span class="token function">node</span> affinity/selector<span class="token punctuation">;</span> <span class="token assign-left variable">debugInfo</span><span class="token operator">=</span>
I1223 <span class="token number">18</span>:01:31.934110       <span class="token number">1</span> scale_up.go:300<span class="token punctuation">]</span> Pod nginx-deploy-b-58f74dd7b9-75s8l can<span class="token string">'t be scheduled on terraform-20221223072925690300000014, predicate checking error: node(s) didn'</span>t match Pod<span class="token string">'s node affinity/selector; predicateName=NodeAffinity; reasons: node(s) didn'</span>t match Pod<span class="token string">'s node affinity/selector; debugInfo=
I1223 18:01:31.934189       1 scale_up.go:300] Pod nginx-deploy-b-58f74dd7b9-dgmq9 can'</span>t be scheduled on terraform-20221223072925690300000014, predicate checking error: node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> didn<span class="token string">'t match Pod'</span>s <span class="token function">node</span> affinity/selector<span class="token punctuation">;</span> <span class="token assign-left variable">predicateName</span><span class="token operator">=</span>NodeAffinity<span class="token punctuation">;</span> reasons: node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> didn<span class="token string">'t match Pod'</span>s <span class="token function">node</span> affinity/selector<span class="token punctuation">;</span> <span class="token assign-left variable">debugInfo</span><span class="token operator">=</span>
I1223 <span class="token number">18</span>:01:31.934273       <span class="token number">1</span> scale_up.go:449<span class="token punctuation">]</span> No pod can fit to terraform-20221223072925690300000014</code></pre></div>
<h3>결론</h3>
<ul>
<li>개별 배포가 필요하지 않은 경우라면 하나의 배포를 수행한다.
<ul>
<li>개별 배포를 수행할 경우 관리 지점이 늘어난다.</li>
<li>가용 영역 별로 세밀한 배포가 필요한 경우에는 개별 배포를 수행한다.</li>
</ul>
</li>
<li>각 가용 영역에 개별 배포가 필요한 경우(예: PV로 AWS EBS를 사용하는 경우) 3개의 ASG를 이용한다.
<ul>
<li>하나의 ASG를 이용할 경우 Cluster Autoscaler가 스케일이 필요한 가용 영역을 찾는데 오버헤드가 발생한다.</li>
</ul>
</li>
<li>모든 가용 영역에 하나의 배포를 수행할 경우 1개 또는 3개의 ASG를 사용할 수 있다.
<ul>
<li>1개의 ASG를 이용할 경우 AWS ASG에 의존하여 스케일링 한다.
<ul>
<li>기본적으로 AWS ASG는 가용 영역 간의 노드 수 균형을 유지하며 스케일링 한다.</li>
</ul>
</li>
<li>3개의 ASG를 이용할 경우 Cluster Autoscaler에 의존하여 스케일링 한다.
<ul>
<li>Cluster Autoscaler의 <code class="language-text">--balance-similar-node-groups</code> 옵션을 이용하여 가용 영역 간의 노드 수 균형을 유지할 수 있다.</li>
</ul>
</li>
</ul>
</li>
</ul></div><ul class="post-styles__LinkList-sc-uvw59-3 kserr"><li><a rel="prev" class="styled-link__StyledLink-sc-1pzq7s8-0 iShFSJ" href="/ingress-nginx-413/">← <!-- -->Ingress nginx 413 에러 해결하기</a></li><li></li></ul><div class="comments-wrapper"><div>Loading script...</div><div></div></div><div class="share__Container-sc-1hk3kno-0 exQjBI"><p class="share___StyledP-sc-1hk3kno-1 fqVogR">Share if you liked it:</p></div></article><footer class="layout__Footer-sc-wzore3-0 lhUvbS"></footer></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/ca-in-multiple-az-cluster/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-f8c2cc276337d80bd885.js\"],\"component---cache-caches-gatsby-plugin-offline-app-shell-js\":[\"/component---cache-caches-gatsby-plugin-offline-app-shell-js-aee18c87e6f082fb8c12.js\"],\"component---src-pages-404-js\":[\"/component---src-pages-404-js-49d580e824070876fdc0.js\"],\"component---src-pages-index-js\":[\"/component---src-pages-index-js-ce506ebec801b4f6085c.js\"],\"component---src-pages-search-js\":[\"/component---src-pages-search-js-0211d4d61592e0a957ba.js\"],\"component---src-templates-blog-post-js\":[\"/component---src-templates-blog-post-js-c85f0063df358931e274.js\"],\"component---src-templates-tags-js\":[\"/component---src-templates-tags-js-fb2e12957e97be8edfcb.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="81f4e81e42d8f3c7db7c";</script><script src="/webpack-runtime-b2be3c64d98ea526aa34.js" async></script><script src="/framework-4b14525e73d2c13c30f6.js" async></script><script src="/app-f8c2cc276337d80bd885.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>