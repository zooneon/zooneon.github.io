{"componentChunkName":"component---src-templates-blog-post-js","path":"/ingress-nginx-413/","result":{"data":{"site":{"siteMetadata":{"title":"zooneon's log","author":"zooneon"}},"markdownRemark":{"id":"8e05b51e-f930-55c7-b8f3-4e2bd64c100a","excerpt":"개요 현재 진행 중인 사이드 프로젝트의 개발 환경을 위해 온프레미스상에 쿠버네티스 클러스터를 구축하고 관리하고 있다. 개발을 진행하면서 클라이언트와 백엔드 서버가 통신하는 과정에 문제가 발생하였다. 이미지 업로드 요구사항으로 최대 1…","html":"<h3>개요</h3>\n<p>현재 진행 중인 사이드 프로젝트의 개발 환경을 위해 온프레미스상에 쿠버네티스 클러스터를 구축하고 관리하고 있다.</p>\n<p>개발을 진행하면서 클라이언트와 백엔드 서버가 통신하는 과정에 문제가 발생하였다.</p>\n<p>이미지 업로드 요구사항으로 최대 10개까지 가능해야 했지만, 3개 이상 보낼 경우 클라이언트에 다음과 같은 에러가 발생하였다.</p>\n<p>(현재 클라이언트로 안드로이드 애플리케이션을 개발하고 있다.)</p>\n<p><img src=\"https://user-images.githubusercontent.com/59433441/208373346-68852df2-3434-48c0-b7de-ad9087801ab3.png\" alt=\"android 413\"></p>\n<p>요청 파일 크기가 업로드 가능한 용량을 초과하는 문제인 것 같아서 <code class=\"language-text\">ingress nginx controller</code> 로그를 확인해 보니 다음과 같이 <code class=\"language-text\">413(Request Entity Too Large)</code> 에러가 발생하고 있었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">2022</span>/12/18 <span class=\"token number\">16</span>:15:26 <span class=\"token punctuation\">[</span>error<span class=\"token punctuation\">]</span> <span class=\"token number\">1396</span><span class=\"token comment\">#1396: *94696338 client intended to send too large body: 2905329 bytes, client: 10.244.219.64, server: api.comeeatme.zooneon.dev, request: \"POST /v1/images/scaled HTTP/2.0\", host: \"api.comeeatme.zooneon.dev\"</span>\n<span class=\"token number\">10.244</span>.219.64 - - <span class=\"token punctuation\">[</span><span class=\"token number\">18</span>/Dec/2022:16:15:26 +0000<span class=\"token punctuation\">]</span> <span class=\"token string\">\"POST /v1/images/scaled HTTP/2.0\"</span> <span class=\"token number\">413</span> <span class=\"token number\">176</span> <span class=\"token string\">\"-\"</span> <span class=\"token string\">\"okhttp/4.10.0\"</span> <span class=\"token number\">76</span> <span class=\"token number\">0.000</span> <span class=\"token punctuation\">[</span>-<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> - - - - 99054c4f5c1643dc555b8964df874e62</code></pre></div>\n<p>클라이언트에서 파일 크기를 줄여 전송하는 방법도 있지만 이미 최대로 압축한 상태라 화질 저하 등 사용자 경험에 영향을 줄 수 있기 때문에 백엔드에서 업로드 크기 제한을 늘리기로 하였다.</p>\n<h3>업로드 크기 제한 늘리기</h3>\n<p><code class=\"language-text\">ingress nginx controller</code>의 파일 업로드 크기 제한을 늘리는 방법은 두 가지가 있다.</p>\n<p>먼저 <code class=\"language-text\">ConfigMap</code>을 이용하여 글로벌 설정을 바꾸는 방법이다.</p>\n<p>(<code class=\"language-text\">nginx ingress controller</code>를 사용하는 경우 해당 설정과 다르다. <a href=\"https://docs.nginx.com/nginx-ingress-controller/configuration/global-configuration/configmap-resource/\">링크</a> 참고)</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ConfigMap\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ingress<span class=\"token punctuation\">-</span>nginx<span class=\"token punctuation\">-</span>controller\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> ingress<span class=\"token punctuation\">-</span>nginx\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app.kubernetes.io/name</span><span class=\"token punctuation\">:</span> ingress<span class=\"token punctuation\">-</span>nginx\n    <span class=\"token key atrule\">app.kubernetes.io/part-of</span><span class=\"token punctuation\">:</span> ingress<span class=\"token punctuation\">-</span>nginx\n<span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">proxy-body-size</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'100m'</span></code></pre></div>\n<p>두 번째로 <code class=\"language-text\">Ingress</code>에 어노테이션을 적용하는 방법이 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">nginx.ingress.kubernetes.io/proxy-body-size</span><span class=\"token punctuation\">:</span> 8m</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> extensions/v1beta1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Ingress\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">nginx.ingress.kubernetes.io/proxy-body-size</span><span class=\"token punctuation\">:</span> 100m\n    <span class=\"token punctuation\">...</span></code></pre></div>\n<h3>결론</h3>\n<p>현재 백엔드 애플리케이션 뿐만 아니라 다른 서비스들도 <code class=\"language-text\">Ingress nginx</code>로 노출시키고 있는데, 해당 기능을 위해 글로벌 설정을 변경하는 것은 불필요하다고 판단하였다.</p>\n<p>(행여나 다른 서비스에서 크기가 큰 비정상 데이터 요청이 발생할 경우 적절하게 에러를 던지지 못하고 이로 인해 병목 현상이 발생할 수 있다고 생각하였다.)</p>\n<p>따라서 어노테이션을 이용하여 해당 <code class=\"language-text\">Ingress</code> 규칙을 수정하는 방안을 선택하였다.</p>\n<p>최대 허용 크기는 WAS에 설정한 크기와 동일하게 100MB로 설정하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> networking.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Ingress\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app.kubernetes.io/name</span><span class=\"token punctuation\">:</span> comeeatme\n    <span class=\"token key atrule\">app.kubernetes.io/instance</span><span class=\"token punctuation\">:</span> comeeatme<span class=\"token punctuation\">-</span>server<span class=\"token punctuation\">-</span>ing\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> comeeatme<span class=\"token punctuation\">-</span>server<span class=\"token punctuation\">-</span>ing\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> comeeatme\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">kubernetes.io/ingress.class</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"nginx\"</span>\n    <span class=\"token key atrule\">nginx.ingress.kubernetes.io/proxy-body-size</span><span class=\"token punctuation\">:</span> 100m\n    <span class=\"token punctuation\">...</span></code></pre></div>\n<p>다시 요청을 시도해 보면 정상적으로 처리하고 있음을 확인할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">2022</span>/12/18 <span class=\"token number\">17</span>:44:42 <span class=\"token punctuation\">[</span>warn<span class=\"token punctuation\">]</span> <span class=\"token number\">1536</span><span class=\"token comment\">#1536: *94783283 a client request body is buffered to a temporary file /tmp/nginx/client-body/0000000208, client: 10.244.219.64, server: api.comeeatme.zooneon.dev, request: \"POST /v1/images/scaled HTTP/2.0\", host: \"api.comeeatme.zooneon.dev\"</span>\n<span class=\"token number\">10.244</span>.219.64 - - <span class=\"token punctuation\">[</span><span class=\"token number\">18</span>/Dec/2022:17:44:45 +0000<span class=\"token punctuation\">]</span> <span class=\"token string\">\"POST /v1/images/scaled HTTP/2.0\"</span> <span class=\"token number\">200</span> <span class=\"token number\">63</span> <span class=\"token string\">\"-\"</span> <span class=\"token string\">\"okhttp/4.10.0\"</span> <span class=\"token number\">2949754</span> <span class=\"token number\">3.266</span> <span class=\"token punctuation\">[</span>comeeatme-comeeatme-server-svc-80<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token number\">10.244</span>.235.134:8080 <span class=\"token number\">74</span> <span class=\"token number\">2.280</span> <span class=\"token number\">200</span> 9e72b889113b29c30dfa77d14e42d870\n<span class=\"token number\">10.244</span>.219.64 - - <span class=\"token punctuation\">[</span><span class=\"token number\">18</span>/Dec/2022:17:44:46 +0000<span class=\"token punctuation\">]</span> <span class=\"token string\">\"POST /v1/post HTTP/2.0\"</span> <span class=\"token number\">200</span> <span class=\"token number\">33</span> <span class=\"token string\">\"-\"</span> <span class=\"token string\">\"okhttp/4.10.0\"</span> <span class=\"token number\">131</span> <span class=\"token number\">0.183</span> <span class=\"token punctuation\">[</span>comeeatme-comeeatme-server-svc-80<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token number\">10.244</span>.235.134:8080 <span class=\"token number\">44</span> <span class=\"token number\">0.182</span> <span class=\"token number\">200</span> e1c5bc5177f0e329162f71ad7f4a68d2</code></pre></div>\n<hr>\n<p>참고</p>\n<ul>\n<li><a href=\"https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#custom-max-body-size\">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#custom-max-body-size</a></li>\n<li><a href=\"https://github.com/kubernetes/ingress-nginx/blob/main/docs/examples/customization/custom-configuration/configmap.yaml\">https://github.com/kubernetes/ingress-nginx/blob/main/docs/examples/customization/custom-configuration/configmap.yaml</a></li>\n</ul>","fields":{"readingTime":{"text":"4 min read"}},"frontmatter":{"title":"Ingress nginx 413 에러 해결하기","date":"December 19, 2022"}}},"pageContext":{"slug":"/ingress-nginx-413/","previous":{"fields":{"slug":"/kubeadm-cloud-provider-aws/"},"frontmatter":{"title":"AWS에서 쿠버네티스 클러스터 구축하기","tags":["kubernetes","aws"]}},"next":{"fields":{"slug":"/ca-in-multiple-az-cluster/"},"frontmatter":{"title":"다중 가용 영역 클러스터에 Cluster Autoscaler 도입하기","tags":["kubernetes","aws","cluster-autoscaler"]}}}},"staticQueryHashes":["3649515864","461697574","983108779"],"slicesMap":{}}