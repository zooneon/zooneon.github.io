{"componentChunkName":"component---src-templates-blog-post-js","path":"/ca-in-multiple-az-cluster/","result":{"data":{"site":{"siteMetadata":{"title":"zooneon's log","author":"zooneon"}},"markdownRemark":{"id":"cbaffc0f-5d28-5ac8-ab0a-c94e41e0bef8","excerpt":"…","html":"<h3>개요</h3>\n<p>고가용성을 위한 인프라 환경 제공이라는 주제로 프로젝트를 진행하면서 쿠버네티스 클러스터에 오토스케일러를 도입하였다.</p>\n<p>먼저 <code class=\"language-text\">HPA</code>를 이용하여 파드 스케일링이 가능하도록 하였지만, 노드에 리소스가 없을 경우 스케일 아웃된 파드가 스케줄되지 못하고 <code class=\"language-text\">Pending</code> 상태에 남게 되는 문제가 발생하였다.</p>\n<p>이를 해결하기 위해 <a href=\"https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler\">Cluster Autoscaler</a>를 도입하였다.</p>\n<p><code class=\"language-text\">Cluster Autoscaler</code>에 대해 간단히 설명하자면 클러스터의 상태를 감시하고 있다가 필요한 경우 클라우드 프로바이더의 오토스케일링 서비스를 이용하여 노드 스케일링을 진행한다.</p>\n<p><code class=\"language-text\">Cluster Autoscaler</code>를 도입하기 앞서 어떻게 적용할지 결정해야 했다.</p>\n<p>AWS 환경에서 고가용성을 위해 3개의 가용 영역(AZ)에 걸쳐 쿠버네티스 클러스터를 구축하였는데, 애플리케이션 배포 방법과 오토스케일링 그룹(ASG)를 어떻게 묶느냐에 따라 달랐다.</p>\n<p>다음과 같이 총 4가지 방법을 생각하였다.</p>\n<ul>\n<li><code class=\"language-text\">1 AutoScalingGroup</code> + <code class=\"language-text\">1 Deployment</code></li>\n<li><code class=\"language-text\">1 AutoScalingGroup</code> + <code class=\"language-text\">3 Deployment</code></li>\n<li><code class=\"language-text\">3 AutoScalingGroup</code> + <code class=\"language-text\">1 Deployment</code></li>\n<li><code class=\"language-text\">3 AutoScalingGroup</code> + <code class=\"language-text\">3 Deployment</code></li>\n</ul>\n<p>결론을 내리기 위해 각 방법에 따라 가설을 세우고 테스트를 통한 검증 과정이 필요했다.</p>\n<h3>테스트 환경</h3>\n<ul>\n<li>kubernetes v1.21.1</li>\n<li>Cluster Autoscaler v1.22.2</li>\n<li>각 가용 영역에 2개의 worker 노드 배치(default)</li>\n<li>원활한 테스트를 위해 파드 리소스 지정\n<ul>\n<li>현재 설정으로 하나의 노드에 최대 3개 파드 배포 가능</li>\n</ul>\n</li>\n</ul>\n<h3>가설 정의</h3>\n<ul>\n<li><code class=\"language-text\">1 AutoScalingGroup</code> + <code class=\"language-text\">1 Deployment</code>\n<ul>\n<li>1개의 배포를 수행하여 자동으로 각 가용 영역에 균등하게 배포 가능</li>\n<li>하나의 배포만 관리</li>\n<li>cluster autoscaler가 특정 가용 영역을 찾기 위한 오버헤드가 존재하지 않음</li>\n</ul>\n</li>\n<li><code class=\"language-text\">1 AutoScalingGroup</code> + <code class=\"language-text\">3 Deployment</code>\n<ul>\n<li>3개의 배포를 수행하여 수동으로 각 가용 영역에 균등하게 배포 가능</li>\n<li>3개의 배포를 관리해야 하므로 관리 포인트가 증가(hpa도 3개 관리해야 함)</li>\n<li>cluster autoscaler가 모든 가용 영역을 포함하는 하나의 asg를 관리하므로 스케일이 필요한 특정 가용 영역을 찾기 위한 오버헤드가 발생\n<ul>\n<li>예) zone A에 스케일이 필요한 상태에서 cluster autoscaler는 zone A가 아닌 zone B 또는 zone C에 노드를 생성하여 파드 스케줄링이 지연됨</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><code class=\"language-text\">3 AutoScalingGroup</code> + <code class=\"language-text\">1 Deployment</code>\n<ul>\n<li>1개의 배포를 수행하여 자동으로 각 가용 영역에 균등하게 배포 가능</li>\n<li>하나의 배포만 관리</li>\n<li>특정 가용 영역이 다운됐을 경우 self healing을 통해 다른 노드그룹으로 마이그레이션 가능</li>\n</ul>\n</li>\n<li><code class=\"language-text\">3 AutoScalingGroup</code> + <code class=\"language-text\">3 Deployment</code>\n<ul>\n<li>3개의 배포를 수행하여 수동으로 각 가용 영역에 균등하게 배포 가능</li>\n<li>3개의 배포를 관리해야 하므로 관리 포인트가 증가(hpa도 3개 관리해야 함)</li>\n<li>cluster autoscaler가 특정 가용 영역을 찾기 위한 오버헤드가 존재하지 않음</li>\n<li>특정 가용 영역이 다운됐을 경우 self healing되지 않음</li>\n</ul>\n</li>\n</ul>\n<h3>가설 검증</h3>\n<p><code class=\"language-text\">1 AutoScalingGroup</code> + <code class=\"language-text\">1 Deployment</code></p>\n<p><img src=\"https://user-images.githubusercontent.com/59433441/209476487-f2750191-9fa0-4174-806b-6b5e989d25de.png\" alt=\"1asg + 1deploy\"></p>\n<p>1개의 배포를 수행하여 자동으로 각 가용 영역에 균등하게 배포 가능<br>\n각 가용 영역에 배포되도록 zone을 topology로 하는 <code class=\"language-text\">soft pod anti affinity</code> 적용(<code class=\"language-text\">hard affinity</code>를 적용할 경우 배포가 정상적으로 수행되지 않을 수도 있으므로)</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># nginx-deploy.yaml</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>deploy\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">6</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">affinity</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">podAntiAffinity</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">preferredDuringSchedulingIgnoredDuringExecution</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">weight</span><span class=\"token punctuation\">:</span> <span class=\"token number\">100</span>\n              <span class=\"token key atrule\">podAffinityTerm</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">topologyKey</span><span class=\"token punctuation\">:</span> topology.kubernets.io/zone\n                <span class=\"token key atrule\">labelSelector</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token key atrule\">matchExpressions</span><span class=\"token punctuation\">:</span>\n                    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> app\n                      <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In\n                      <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span>\n                        <span class=\"token punctuation\">-</span> nginx\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx\n          <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'500m'</span>\n              <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'256Mi'</span>\n            <span class=\"token key atrule\">limits</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'500m'</span>\n              <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'256Mi'</span>\n          <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></code></pre></div>\n<p>가용 영역마다 균등하게 배포된 것 확인</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k get po -o wide</span>\nNAME                            READY   STATUS    RESTARTS   AGE   IP               NODE                                            NOMINATED NODE   READINESS GATES\nnginx-deploy-55d455cb69-56zjd   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          13s   <span class=\"token number\">192.168</span>.195.1    ip-10-0-5-174.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-55d455cb69-679xs   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          13s   <span class=\"token number\">192.168</span>.150.65   ip-10-0-4-94.ap-northeast-2.compute.internal    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-55d455cb69-9rc6w   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          13s   <span class=\"token number\">192.168</span>.37.129   ip-10-0-4-89.ap-northeast-2.compute.internal    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-55d455cb69-cxmz5   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          13s   <span class=\"token number\">192.168</span>.95.65    ip-10-0-5-243.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-55d455cb69-fwgf9   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          13s   <span class=\"token number\">192.168</span>.152.65   ip-10-0-3-169.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-55d455cb69-mddq2   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          13s   <span class=\"token number\">192.168</span>.50.193   ip-10-0-3-203.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></code></pre></div>\n<p>하나의 배포만 관리\n모든 가용 영역에 배포하기 위해 1개의 배포를 수행한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k get deploy</span>\nNAME           READY   UP-TO-DATE   AVAILABLE   AGE\nnginx-deploy   <span class=\"token number\">6</span>/6     <span class=\"token number\">6</span>            <span class=\"token number\">6</span>           9m8s</code></pre></div>\n<p>cluster autoscaler가 특정 가용 영역을 찾기 위한 오버헤드가 존재하지 않음\n테스트를 위해 레플리카 수 조정</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k scale deploy nginx-deploy --replicas=21</span>\ndeployment.apps/nginx-deploy scaled</code></pre></div>\n<p>파드를 스케줄링할 수 없자 cluster autoscaler가 이를 감지하고 스케일 아웃 진행</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k get po |grep Pending</span>\nnginx-deploy-5975cd4c6f-khvm4   <span class=\"token number\">0</span>/1     Pending   <span class=\"token number\">0</span>          4s\nnginx-deploy-5975cd4c6f-fzvs5   <span class=\"token number\">0</span>/1     Pending   <span class=\"token number\">0</span>          4s\nnginx-deploy-5975cd4c6f-cr89p   <span class=\"token number\">0</span>/1     Pending   <span class=\"token number\">0</span>          4s</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k logs cluster-autoscaler-5fc547f877-6btxr -n kube-system</span>\n<span class=\"token punctuation\">..</span>\nI1223 <span class=\"token number\">12</span>:28:45.755920       <span class=\"token number\">1</span> waste.go:57<span class=\"token punctuation\">]</span> Expanding Node Group terraform-20221223072925690300000012 would waste <span class=\"token number\">25.00</span>% CPU, <span class=\"token number\">80.12</span>% Memory, <span class=\"token number\">52.56</span>% Blended\nI1223 <span class=\"token number\">12</span>:28:45.756018       <span class=\"token number\">1</span> scale_up.go:468<span class=\"token punctuation\">]</span> Best option to resize: terraform-20221223072925690300000012\nI1223 <span class=\"token number\">12</span>:28:45.756102       <span class=\"token number\">1</span> scale_up.go:472<span class=\"token punctuation\">]</span> Estimated <span class=\"token number\">1</span> nodes needed <span class=\"token keyword\">in</span> terraform-20221223072925690300000012\nI1223 <span class=\"token number\">12</span>:28:45.756171       <span class=\"token number\">1</span> scale_up.go:586<span class=\"token punctuation\">]</span> Final scale-up plan: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>terraform-20221223072925690300000012 <span class=\"token number\">6</span>-<span class=\"token operator\">></span><span class=\"token number\">7</span> <span class=\"token punctuation\">(</span>max: <span class=\"token number\">12</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\nI1223 <span class=\"token number\">12</span>:28:45.756242       <span class=\"token number\">1</span> scale_up.go:675<span class=\"token punctuation\">]</span> Scale-up: setting group terraform-20221223072925690300000012 size to <span class=\"token number\">7</span>\nI1223 <span class=\"token number\">12</span>:28:45.756323       <span class=\"token number\">1</span> auto_scaling_groups.go:219<span class=\"token punctuation\">]</span> Setting asg terraform-20221223072925690300000012 size to <span class=\"token number\">7</span>\nI1223 <span class=\"token number\">12</span>:28:45.756770       <span class=\"token number\">1</span> event_sink_logging_wrapper.go:48<span class=\"token punctuation\">]</span> Event<span class=\"token punctuation\">(</span>v1.ObjectReference<span class=\"token punctuation\">{</span>Kind:<span class=\"token string\">\"ConfigMap\"</span>, Namespace:<span class=\"token string\">\"kube-system\"</span>, Name:<span class=\"token string\">\"cluster-autoscaler-status\"</span>, <span class=\"token environment constant\">UID</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"4b58a55c-87b4-43a7-9894-5e469cc3690f\"</span>, APIVersion:<span class=\"token string\">\"v1\"</span>, ResourceVersion:<span class=\"token string\">\"55421\"</span>, FieldPath:<span class=\"token string\">\"\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>: type: <span class=\"token string\">'Normal'</span> reason: <span class=\"token string\">'ScaledUpGroup'</span> Scale-up: setting group terraform-20221223072925690300000012 size to <span class=\"token number\">7</span>\nI1223 <span class=\"token number\">12</span>:28:45.912416       <span class=\"token number\">1</span> eventing_scale_up_processor.go:47<span class=\"token punctuation\">]</span> Skipping event processing <span class=\"token keyword\">for</span> unschedulable pods since there is a ScaleUp attempt this loop\nI1223 <span class=\"token number\">12</span>:28:45.912866       <span class=\"token number\">1</span> event_sink_logging_wrapper.go:48<span class=\"token punctuation\">]</span> Event<span class=\"token punctuation\">(</span>v1.ObjectReference<span class=\"token punctuation\">{</span>Kind:<span class=\"token string\">\"Pod\"</span>, Namespace:<span class=\"token string\">\"default\"</span>, Name:<span class=\"token string\">\"nginx-deploy-5975cd4c6f-khvm4\"</span>, <span class=\"token environment constant\">UID</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"aed89bd2-7f3c-4a04-938e-8af952582c65\"</span>, APIVersion:<span class=\"token string\">\"v1\"</span>, ResourceVersion:<span class=\"token string\">\"55405\"</span>, FieldPath:<span class=\"token string\">\"\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>: type: <span class=\"token string\">'Normal'</span> reason: <span class=\"token string\">'TriggeredScaleUp'</span> pod triggered scale-up: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>terraform-20221223072925690300000012 <span class=\"token number\">6</span>-<span class=\"token operator\">></span><span class=\"token number\">7</span> <span class=\"token punctuation\">(</span>max: <span class=\"token number\">12</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\nI1223 <span class=\"token number\">12</span>:28:45.936356       <span class=\"token number\">1</span> event_sink_logging_wrapper.go:48<span class=\"token punctuation\">]</span> Event<span class=\"token punctuation\">(</span>v1.ObjectReference<span class=\"token punctuation\">{</span>Kind:<span class=\"token string\">\"Pod\"</span>, Namespace:<span class=\"token string\">\"default\"</span>, Name:<span class=\"token string\">\"nginx-deploy-5975cd4c6f-fzvs5\"</span>, <span class=\"token environment constant\">UID</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"59200ce3-668b-4a33-902b-cce3511d77bf\"</span>, APIVersion:<span class=\"token string\">\"v1\"</span>, ResourceVersion:<span class=\"token string\">\"55412\"</span>, FieldPath:<span class=\"token string\">\"\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>: type: <span class=\"token string\">'Normal'</span> reason: <span class=\"token string\">'TriggeredScaleUp'</span> pod triggered scale-up: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>terraform-20221223072925690300000012 <span class=\"token number\">6</span>-<span class=\"token operator\">></span><span class=\"token number\">7</span> <span class=\"token punctuation\">(</span>max: <span class=\"token number\">12</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\nI1223 <span class=\"token number\">12</span>:28:45.966979       <span class=\"token number\">1</span> event_sink_logging_wrapper.go:48<span class=\"token punctuation\">]</span> Event<span class=\"token punctuation\">(</span>v1.ObjectReference<span class=\"token punctuation\">{</span>Kind:<span class=\"token string\">\"Pod\"</span>, Namespace:<span class=\"token string\">\"default\"</span>, Name:<span class=\"token string\">\"nginx-deploy-5975cd4c6f-cr89p\"</span>, <span class=\"token environment constant\">UID</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"743556f7-8ca7-4db3-8d20-ace37a1d2738\"</span>, APIVersion:<span class=\"token string\">\"v1\"</span>, ResourceVersion:<span class=\"token string\">\"55414\"</span>, FieldPath:<span class=\"token string\">\"\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>: type: <span class=\"token string\">'Normal'</span> reason: <span class=\"token string\">'TriggeredScaleUp'</span> pod triggered scale-up: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>terraform-20221223072925690300000012 <span class=\"token number\">6</span>-<span class=\"token operator\">></span><span class=\"token number\">7</span> <span class=\"token punctuation\">(</span>max: <span class=\"token number\">12</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">..</span>\nI1223 <span class=\"token number\">12</span>:28:55.951121       <span class=\"token number\">1</span> static_autoscaler.go:231<span class=\"token punctuation\">]</span> Starting main loop\nI1223 <span class=\"token number\">12</span>:28:55.952023       <span class=\"token number\">1</span> filter_out_schedulable.go:65<span class=\"token punctuation\">]</span> Filtering out schedulables\nI1223 <span class=\"token number\">12</span>:28:55.952044       <span class=\"token number\">1</span> filter_out_schedulable.go:132<span class=\"token punctuation\">]</span> Filtered out <span class=\"token number\">0</span> pods using hints\nI1223 <span class=\"token number\">12</span>:28:55.952190       <span class=\"token number\">1</span> filter_out_schedulable.go:157<span class=\"token punctuation\">]</span> Pod default.nginx-deploy-5975cd4c6f-khvm4 marked as unschedulable can be scheduled on <span class=\"token function\">node</span> template-node-for-terraform-20221223072925690300000012-203101283895217702-upcoming-0. Ignoring <span class=\"token keyword\">in</span> scale up.\nI1223 <span class=\"token number\">12</span>:28:55.952337       <span class=\"token number\">1</span> filter_out_schedulable.go:157<span class=\"token punctuation\">]</span> Pod default.nginx-deploy-5975cd4c6f-fzvs5 marked as unschedulable can be scheduled on <span class=\"token function\">node</span> template-node-for-terraform-20221223072925690300000012-203101283895217702-upcoming-0. Ignoring <span class=\"token keyword\">in</span> scale up.\nI1223 <span class=\"token number\">12</span>:28:55.952419       <span class=\"token number\">1</span> filter_out_schedulable.go:157<span class=\"token punctuation\">]</span> Pod default.nginx-deploy-5975cd4c6f-cr89p marked as unschedulable can be scheduled on <span class=\"token function\">node</span> template-node-for-terraform-20221223072925690300000012-203101283895217702-upcoming-0. Ignoring <span class=\"token keyword\">in</span> scale up.\nI1223 <span class=\"token number\">12</span>:28:55.952441       <span class=\"token number\">1</span> filter_out_schedulable.go:170<span class=\"token punctuation\">]</span> <span class=\"token number\">0</span> pods were kept as unschedulable based on caching\nI1223 <span class=\"token number\">12</span>:28:55.952450       <span class=\"token number\">1</span> filter_out_schedulable.go:171<span class=\"token punctuation\">]</span> <span class=\"token number\">3</span> pods marked as unschedulable can be scheduled.</code></pre></div>\n<p>cluster autoscaler가 노드를 생성하여 파드가 정상적으로 스케줄링 됨</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k get no</span>\nNAME                                            STATUS   ROLES                  AGE     VERSION\nip-10-0-3-100.ap-northeast-2.compute.internal   Ready    control-plane,master   4h59m   v1.21.1\nip-10-0-3-169.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 4h27m   v1.21.1\nip-10-0-3-203.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 4h29m   v1.21.1\nip-10-0-4-89.ap-northeast-2.compute.internal    Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 4h25m   v1.21.1\nip-10-0-4-94.ap-northeast-2.compute.internal    Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 4h25m   v1.21.1\nip-10-0-5-174.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 4h26m   v1.21.1\nip-10-0-5-190.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 117s    v1.21.1\nip-10-0-5-243.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 4h29m   v1.21.1</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k get po</span>\nNAME                            READY   STATUS    RESTARTS   AGE\nnginx-deploy-5975cd4c6f-2mhkc   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          14m\nnginx-deploy-5975cd4c6f-85gwz   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          14m\nnginx-deploy-5975cd4c6f-8cgqw   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          14m\nnginx-deploy-5975cd4c6f-8rzwx   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          14m\nnginx-deploy-5975cd4c6f-cc4j9   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          14m\nnginx-deploy-5975cd4c6f-cr89p   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          3m47s\nnginx-deploy-5975cd4c6f-f44qx   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          14m\nnginx-deploy-5975cd4c6f-fgh7p   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          14m\nnginx-deploy-5975cd4c6f-fhgrm   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          14m\nnginx-deploy-5975cd4c6f-fzvs5   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          3m47s\nnginx-deploy-5975cd4c6f-g4dvn   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          14m\nnginx-deploy-5975cd4c6f-gn598   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          14m\nnginx-deploy-5975cd4c6f-gzvx5   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          14m\nnginx-deploy-5975cd4c6f-hckgt   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          14m\nnginx-deploy-5975cd4c6f-hfggr   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          14m\nnginx-deploy-5975cd4c6f-hv5gt   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          14m\nnginx-deploy-5975cd4c6f-jbbx4   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          14m\nnginx-deploy-5975cd4c6f-khvm4   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          3m47s\nnginx-deploy-5975cd4c6f-mgxp8   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          14m\nnginx-deploy-5975cd4c6f-psxsl   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          14m\nnginx-deploy-5975cd4c6f-sl9hc   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          14m</code></pre></div>\n<p><code class=\"language-text\">1 AutoScalingGroup</code> + <code class=\"language-text\">3 Deployment</code></p>\n<p><img src=\"https://user-images.githubusercontent.com/59433441/209476489-0a37fe55-4141-4096-9ba7-96b22a768836.png\" alt=\"1asg + 3deploy\">\n3개의 배포를 수행하여 수동으로 각 가용 영역에 균등하게 배포 가능<br>\n각 가용 영역에 배포되도록 zone을 topology로 하는 <code class=\"language-text\">hard node affinity</code> 적용(해당 배포는 특정 영역에만 배포되어야 하기 때문에)</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># nginx-deploy-a.yaml</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>deploy<span class=\"token punctuation\">-</span>a\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">affinity</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">nodeAffinity</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">requiredDuringSchedulingIgnoredDuringExecution</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">nodeSelectorTerms</span><span class=\"token punctuation\">:</span>\n              <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">matchExpressions</span><span class=\"token punctuation\">:</span>\n                  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> topology.kubernetes.io/zone\n                    <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span> In\n                    <span class=\"token key atrule\">values</span><span class=\"token punctuation\">:</span>\n                      <span class=\"token punctuation\">-</span> ap<span class=\"token punctuation\">-</span>northeast<span class=\"token punctuation\">-</span>2a\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx\n          <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx\n          <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'500m'</span>\n              <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'256Mi'</span>\n            <span class=\"token key atrule\">limits</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">cpu</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'500m'</span>\n              <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'256Mi'</span>\n          <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></code></pre></div>\n<p>가용 영역마다 균등하게 배포된 것 확인</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k get po -o wide</span>\nNAME                              READY   STATUS    RESTARTS   AGE   IP               NODE                                            NOMINATED NODE   READINESS GATES\nnginx-deploy-a-5587c665fb-8ql7s   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          27s   <span class=\"token number\">192.168</span>.50.196   ip-10-0-3-203.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-a-5587c665fb-hd7fq   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24s   <span class=\"token number\">192.168</span>.152.68   ip-10-0-3-169.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-b-58f74dd7b9-4sn6f   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          21s   <span class=\"token number\">192.168</span>.37.132   ip-10-0-4-89.ap-northeast-2.compute.internal    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-b-58f74dd7b9-nqgsj   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24s   <span class=\"token number\">192.168</span>.150.68   ip-10-0-4-94.ap-northeast-2.compute.internal    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-c-75764c77db-6ltk8   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          22s   <span class=\"token number\">192.168</span>.95.68    ip-10-0-5-243.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-c-75764c77db-x62pt   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          18s   <span class=\"token number\">192.168</span>.195.4    ip-10-0-5-174.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></code></pre></div>\n<p>3개의 배포를 관리해야 하므로 관리 포인트가 증가\n모든 가용 영역에 배포하기 위해 3개의 배포를 수행해야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k get deploy</span>\nNAME             READY   UP-TO-DATE   AVAILABLE   AGE\nnginx-deploy-a   <span class=\"token number\">2</span>/2     <span class=\"token number\">2</span>            <span class=\"token number\">2</span>           28m\nnginx-deploy-b   <span class=\"token number\">2</span>/2     <span class=\"token number\">2</span>            <span class=\"token number\">2</span>           27m\nnginx-deploy-c   <span class=\"token number\">2</span>/2     <span class=\"token number\">2</span>            <span class=\"token number\">2</span>           27m</code></pre></div>\n<p>cluster autoscaler가 모든 가용 영역을 포함하는 하나의 asg를 관리하므로 스케일이 필요한 특정 가용 영역을 찾기 위한 오버헤드가 발생\n테스트를 위해 zone C에 레플리카 수 조정</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k scale deploy nginx-deploy-c --replicas=9</span>\ndeployment.apps/nginx-deploy-c scaled</code></pre></div>\n<p>파드를 스케줄링할 수 없자 cluster autoscaler가 이를 감지하고 스케일 아웃 진행</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k logs cluster-autoscaler-5fc547f877-6btxr -n kube-system</span>\n<span class=\"token punctuation\">..</span>\nI1223 09:47:24.484810       <span class=\"token number\">1</span> static_autoscaler.go:231<span class=\"token punctuation\">]</span> Starting main loop\nI1223 09:47:24.485570       <span class=\"token number\">1</span> static_autoscaler.go:335<span class=\"token punctuation\">]</span> <span class=\"token number\">1</span> unregistered nodes present\nI1223 09:47:24.485833       <span class=\"token number\">1</span> filter_out_schedulable.go:65<span class=\"token punctuation\">]</span> Filtering out schedulables\nI1223 09:47:24.485966       <span class=\"token number\">1</span> filter_out_schedulable.go:132<span class=\"token punctuation\">]</span> Filtered out <span class=\"token number\">0</span> pods using hints\nI1223 09:47:24.486201       <span class=\"token number\">1</span> filter_out_schedulable.go:170<span class=\"token punctuation\">]</span> <span class=\"token number\">0</span> pods were kept as unschedulable based on caching\nI1223 09:47:24.486278       <span class=\"token number\">1</span> filter_out_schedulable.go:171<span class=\"token punctuation\">]</span> <span class=\"token number\">0</span> pods marked as unschedulable can be scheduled.\nI1223 09:47:24.486355       <span class=\"token number\">1</span> filter_out_schedulable.go:82<span class=\"token punctuation\">]</span> No schedulable pods\nI1223 09:47:24.486417       <span class=\"token number\">1</span> klogx.go:86<span class=\"token punctuation\">]</span> Pod default/nginx-deploy-c-75764c77db-z9ccc is unschedulable\nI1223 09:47:24.486482       <span class=\"token number\">1</span> klogx.go:86<span class=\"token punctuation\">]</span> Pod default/nginx-deploy-c-75764c77db-cq4b7 is unschedulable\nI1223 09:47:24.486542       <span class=\"token number\">1</span> klogx.go:86<span class=\"token punctuation\">]</span> Pod default/nginx-deploy-c-75764c77db-z55mb is unschedulable\nI1223 09:47:24.486691       <span class=\"token number\">1</span> scale_up.go:376<span class=\"token punctuation\">]</span> Upcoming <span class=\"token number\">1</span> nodes\nI1223 09:47:24.486843       <span class=\"token number\">1</span> scale_up.go:300<span class=\"token punctuation\">]</span> Pod nginx-deploy-c-75764c77db-z9ccc can<span class=\"token string\">'t be scheduled on terraform-20221223072925690300000012, predicate checking error: node(s) didn'</span>t match Pod<span class=\"token string\">'s node affinity/selector; predicateName=NodeAffinity; reasons: node(s) didn'</span>t match Pod<span class=\"token string\">'s node affinity/selector; debugInfo=\nI1223 09:47:24.486952       1 scale_up.go:300] Pod nginx-deploy-c-75764c77db-cq4b7 can'</span>t be scheduled on terraform-20221223072925690300000012, predicate checking error: node<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> didn<span class=\"token string\">'t match Pod'</span>s <span class=\"token function\">node</span> affinity/selector<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">predicateName</span><span class=\"token operator\">=</span>NodeAffinity<span class=\"token punctuation\">;</span> reasons: node<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> didn<span class=\"token string\">'t match Pod'</span>s <span class=\"token function\">node</span> affinity/selector<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">debugInfo</span><span class=\"token operator\">=</span>\nI1223 09:47:24.487035       <span class=\"token number\">1</span> scale_up.go:300<span class=\"token punctuation\">]</span> Pod nginx-deploy-c-75764c77db-z55mb can<span class=\"token string\">'t be scheduled on terraform-20221223072925690300000012, predicate checking error: node(s) didn'</span>t match Pod<span class=\"token string\">'s node affinity/selector; predicateName=NodeAffinity; reasons: node(s) didn'</span>t match Pod's <span class=\"token function\">node</span> affinity/selector<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">debugInfo</span><span class=\"token operator\">=</span>\nI1223 09:47:24.487101       <span class=\"token number\">1</span> scale_up.go:449<span class=\"token punctuation\">]</span> No pod can fit to terraform-20221223072925690300000012</code></pre></div>\n<p>cluster autoscaler가 스케일링 했지만 zone C가 아닌 zone B에 노드를 생성하여 파드는 여전히 pending 상태</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k get no</span>\nNAME                                            STATUS     ROLES                  AGE     VERSION\nip-10-0-3-100.ap-northeast-2.compute.internal   Ready      control-plane,master   135m    v1.21.1\nip-10-0-3-169.ap-northeast-2.compute.internal   Ready      <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 103m    v1.21.1\nip-10-0-3-203.ap-northeast-2.compute.internal   Ready      <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 105m    v1.21.1\nip-10-0-4-241.ap-northeast-2.compute.internal   Ready      <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 3m19s   v1.21.1\nip-10-0-4-89.ap-northeast-2.compute.internal    Ready      <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 101m    v1.21.1\nip-10-0-4-94.ap-northeast-2.compute.internal    Ready      <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 101m    v1.21.1\nip-10-0-5-174.ap-northeast-2.compute.internal   Ready      <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 103m    v1.21.1\nip-10-0-5-243.ap-northeast-2.compute.internal   Ready      <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 105m    v1.21.1</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">root@ip-10-0-3-100:~<span class=\"token comment\"># k get po |grep Pending</span>\nNAME                              READY   STATUS    RESTARTS   AGE\nnginx-deploy-c-75764c77db-cq4b7   <span class=\"token number\">0</span>/1     Pending   <span class=\"token number\">0</span>          4m31s\nnginx-deploy-c-75764c77db-z55mb   <span class=\"token number\">0</span>/1     Pending   <span class=\"token number\">0</span>          4m31s\nnginx-deploy-c-75764c77db-z9ccc   <span class=\"token number\">0</span>/1     Pending   <span class=\"token number\">0</span>          4m31s</code></pre></div>\n<p>결국 cluster autoscaler가 노드를 하나 더 생성</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k get no</span>\nNAME                                            STATUS   ROLES                  AGE     VERSION\nip-10-0-3-100.ap-northeast-2.compute.internal   Ready    control-plane,master   137m    v1.21.1\nip-10-0-3-169.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 105m    v1.21.1\nip-10-0-3-203.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 107m    v1.21.1\nip-10-0-4-241.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 5m39s   v1.21.1\nip-10-0-4-89.ap-northeast-2.compute.internal    Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 103m    v1.21.1\nip-10-0-4-94.ap-northeast-2.compute.internal    Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 103m    v1.21.1\nip-10-0-5-174.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 105m    v1.21.1\nip-10-0-5-243.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 107m    v1.21.1\nip-10-0-5-80.ap-northeast-2.compute.internal    Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 2m37s   v1.21.1</code></pre></div>\n<p>이제서야 모든 파드가 스케줄링 됨</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k get po |grep nginx-deploy-c</span>\nNAME                              READY   STATUS    RESTARTS   AGE\nnginx-deploy-c-75764c77db-6ltk8   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          31m\nnginx-deploy-c-75764c77db-bjn4n   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8m\nnginx-deploy-c-75764c77db-cq4b7   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          7m31s\nnginx-deploy-c-75764c77db-fb87j   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8m\nnginx-deploy-c-75764c77db-nd7nz   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8m\nnginx-deploy-c-75764c77db-pqwlt   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8m\nnginx-deploy-c-75764c77db-x62pt   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          31m\nnginx-deploy-c-75764c77db-z55mb   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          7m31s\nnginx-deploy-c-75764c77db-z9ccc   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          7m31s</code></pre></div>\n<p><code class=\"language-text\">3 AutoScalingGroup</code> + <code class=\"language-text\">1 Deployment</code></p>\n<p><img src=\"https://user-images.githubusercontent.com/59433441/209476490-c08f69ce-95d6-46e8-9a42-a23ec44f63e9.png\" alt=\"3asg + 1deploy\"></p>\n<p>1개의 배포를 수행하여 자동으로 각 가용 영역에 균등하게 배포 가능<br>\n-> <code class=\"language-text\">1 AutoScalingGroup</code> + <code class=\"language-text\">1 Deployment</code> 방법과 같은 방식으로 배포</p>\n<p>하나의 배포만 관리<br>\n모든 가용 영역에 배포하기 위해 1개의 배포를 수행한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k get deploy</span>\nNAME           READY   UP-TO-DATE   AVAILABLE   AGE\nnginx-deploy   <span class=\"token number\">6</span>/6     <span class=\"token number\">6</span>            <span class=\"token number\">6</span>           26s</code></pre></div>\n<p>특정 가용 영역이 다운됐을 경우 self healing을 통해 다른 노드그룹으로 이동 가능\n특정 가용 영역 다운(zone C에 설정한 asg 삭제)</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k get no</span>\nNAME                                            STATUS   ROLES                  AGE     VERSION\nip-10-0-3-100.ap-northeast-2.compute.internal   Ready    control-plane,master   9h      v1.21.1\nip-10-0-3-116.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 25m     v1.21.1\nip-10-0-3-38.ap-northeast-2.compute.internal    Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 173m    v1.21.1\nip-10-0-4-142.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 14m     v1.21.1\nip-10-0-4-186.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 8m12s   v1.21.1</code></pre></div>\n<p>해당 가용 영역에서 실행 중이던 노드가 다운되면서 파드가 self healing되고 노드에 리소스가 부족하여 pending 상태가 됨</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k get po -o wide</span>\nNAME                            READY   STATUS    RESTARTS   AGE     IP                NODE                                            NOMINATED NODE   READINESS GATES\nnginx-deploy-78d865fc9b-2wbft   <span class=\"token number\">0</span>/1     Pending   <span class=\"token number\">0</span>          5s      <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>            <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                                          <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-57gsg   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m34s   <span class=\"token number\">192.168</span>.60.205    ip-10-0-3-38.ap-northeast-2.compute.internal    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-5nrrt   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          7m37s   <span class=\"token number\">192.168</span>.113.193   ip-10-0-4-142.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-7c7zw   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m34s   <span class=\"token number\">192.168</span>.161.7     ip-10-0-3-116.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-cb8z5   <span class=\"token number\">0</span>/1     Pending   <span class=\"token number\">0</span>          5s      <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>            <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                                          <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-dnp9k   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m34s   <span class=\"token number\">192.168</span>.113.194   ip-10-0-4-142.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-gbhgv   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          7m37s   <span class=\"token number\">192.168</span>.60.203    ip-10-0-3-38.ap-northeast-2.compute.internal    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-kbg9j   <span class=\"token number\">0</span>/1     Pending   <span class=\"token number\">0</span>          4s      <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>            <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                                          <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-kcgrn   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m34s   <span class=\"token number\">192.168</span>.60.204    ip-10-0-3-38.ap-northeast-2.compute.internal    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-l5nzg   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          7m37s   <span class=\"token number\">192.168</span>.218.1     ip-10-0-4-186.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-lfsnz   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m34s   <span class=\"token number\">192.168</span>.218.3     ip-10-0-4-186.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-m66r9   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m34s   <span class=\"token number\">192.168</span>.218.2     ip-10-0-4-186.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-t4wmb   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          7m37s   <span class=\"token number\">192.168</span>.161.5     ip-10-0-3-116.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-tnjpr   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m34s   <span class=\"token number\">192.168</span>.113.195   ip-10-0-4-142.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-v8r87   <span class=\"token number\">0</span>/1     Pending   <span class=\"token number\">0</span>          5s      <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>            <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                                          <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-wblfl   <span class=\"token number\">0</span>/1     Pending   <span class=\"token number\">0</span>          5s      <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>            <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                                          <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-ww2rm   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m34s   <span class=\"token number\">192.168</span>.161.6     ip-10-0-3-116.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-zvjmm   <span class=\"token number\">0</span>/1     Pending   <span class=\"token number\">0</span>          5s      <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>            <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                                          <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></code></pre></div>\n<p>cluster autoscaler가 이를 감지하고 스케일 진행</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k logs cluster-autoscaler-5fc547f877-6btxr -n kube-system</span>\n<span class=\"token punctuation\">..</span>\nI1223 <span class=\"token number\">16</span>:40:56.706010       <span class=\"token number\">1</span> filter_out_schedulable.go:157<span class=\"token punctuation\">]</span> Pod default.nginx-deploy-78d865fc9b-v8r87 marked as unschedulable can be scheduled on <span class=\"token function\">node</span> template-node-for-terraform-20221223072925690300000012-3178448486295206162-upcoming-0. Ignoring <span class=\"token keyword\">in</span> scale up.\nI1223 <span class=\"token number\">16</span>:40:56.706288       <span class=\"token number\">1</span> filter_out_schedulable.go:157<span class=\"token punctuation\">]</span> Pod default.nginx-deploy-78d865fc9b-2wbft marked as unschedulable can be scheduled on <span class=\"token function\">node</span> template-node-for-terraform-20221223072925690300000012-3178448486295206162-upcoming-0. Ignoring <span class=\"token keyword\">in</span> scale up.\nI1223 <span class=\"token number\">16</span>:40:56.706359       <span class=\"token number\">1</span> filter_out_schedulable.go:157<span class=\"token punctuation\">]</span> Pod default.nginx-deploy-78d865fc9b-wblfl marked as unschedulable can be scheduled on <span class=\"token function\">node</span> template-node-for-terraform-20221223072925690300000012-3178448486295206162-upcoming-0. Ignoring <span class=\"token keyword\">in</span> scale up.\nI1223 <span class=\"token number\">16</span>:40:56.706607       <span class=\"token number\">1</span> filter_out_schedulable.go:157<span class=\"token punctuation\">]</span> Pod default.nginx-deploy-78d865fc9b-kbg9j marked as unschedulable can be scheduled on <span class=\"token function\">node</span> template-node-for-terraform-20221223072925690300000012-3178448486295206162-upcoming-1. Ignoring <span class=\"token keyword\">in</span> scale up.\nI1223 <span class=\"token number\">16</span>:40:56.706682       <span class=\"token number\">1</span> filter_out_schedulable.go:157<span class=\"token punctuation\">]</span> Pod default.nginx-deploy-78d865fc9b-zvjmm marked as unschedulable can be scheduled on <span class=\"token function\">node</span> template-node-for-terraform-20221223072925690300000012-3178448486295206162-upcoming-1. Ignoring <span class=\"token keyword\">in</span> scale up.\nI1223 <span class=\"token number\">16</span>:40:56.706901       <span class=\"token number\">1</span> filter_out_schedulable.go:157<span class=\"token punctuation\">]</span> Pod default.nginx-deploy-78d865fc9b-cb8z5 marked as unschedulable can be scheduled on <span class=\"token function\">node</span> template-node-for-terraform-20221223072925690300000012-3178448486295206162-upcoming-1. Ignoring <span class=\"token keyword\">in</span> scale up.\nI1223 <span class=\"token number\">16</span>:40:56.706930       <span class=\"token number\">1</span> filter_out_schedulable.go:170<span class=\"token punctuation\">]</span> <span class=\"token number\">0</span> pods were kept as unschedulable based on caching\nI1223 <span class=\"token number\">16</span>:40:56.706940       <span class=\"token number\">1</span> filter_out_schedulable.go:171<span class=\"token punctuation\">]</span> <span class=\"token number\">6</span> pods marked as unschedulable can be scheduled.</code></pre></div>\n<p>cluster autoscaler가 노드를 생성하여 파드가 정상적으로 스케줄링 됨</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k get no</span>\nNAME                                            STATUS   ROLES                  AGE    VERSION\nip-10-0-3-100.ap-northeast-2.compute.internal   Ready    control-plane,master   9h     v1.21.1\nip-10-0-3-111.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 2m     v1.21.1\nip-10-0-3-116.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 30m    v1.21.1\nip-10-0-3-160.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 2m     v1.21.1\nip-10-0-3-38.ap-northeast-2.compute.internal    Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 178m   v1.21.1\nip-10-0-4-142.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 18m    v1.21.1\nip-10-0-4-186.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 12m    v1.21.1</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k get po -o wide</span>\nNAME                            READY   STATUS    RESTARTS   AGE     IP                NODE                                            NOMINATED NODE   READINESS GATES\nnginx-deploy-78d865fc9b-2wbft   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4m29s   <span class=\"token number\">192.168</span>.28.2      ip-10-0-3-111.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-57gsg   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          6m58s   <span class=\"token number\">192.168</span>.60.205    ip-10-0-3-38.ap-northeast-2.compute.internal    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-5nrrt   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          12m     <span class=\"token number\">192.168</span>.113.193   ip-10-0-4-142.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-7c7zw   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          6m58s   <span class=\"token number\">192.168</span>.161.7     ip-10-0-3-116.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-cb8z5   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4m29s   <span class=\"token number\">192.168</span>.28.3      ip-10-0-3-111.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-dnp9k   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          6m58s   <span class=\"token number\">192.168</span>.113.194   ip-10-0-4-142.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-gbhgv   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          12m     <span class=\"token number\">192.168</span>.60.203    ip-10-0-3-38.ap-northeast-2.compute.internal    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-kbg9j   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4m28s   <span class=\"token number\">192.168</span>.52.2      ip-10-0-3-160.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-kcgrn   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          6m58s   <span class=\"token number\">192.168</span>.60.204    ip-10-0-3-38.ap-northeast-2.compute.internal    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-l5nzg   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          12m     <span class=\"token number\">192.168</span>.218.1     ip-10-0-4-186.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-lfsnz   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          6m58s   <span class=\"token number\">192.168</span>.218.3     ip-10-0-4-186.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-m66r9   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          6m58s   <span class=\"token number\">192.168</span>.218.2     ip-10-0-4-186.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-t4wmb   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          12m     <span class=\"token number\">192.168</span>.161.5     ip-10-0-3-116.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-tnjpr   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          6m58s   <span class=\"token number\">192.168</span>.113.195   ip-10-0-4-142.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-v8r87   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4m29s   <span class=\"token number\">192.168</span>.52.3      ip-10-0-3-160.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-wblfl   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4m29s   <span class=\"token number\">192.168</span>.28.1      ip-10-0-3-111.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-ww2rm   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          6m58s   <span class=\"token number\">192.168</span>.161.6     ip-10-0-3-116.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-78d865fc9b-zvjmm   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4m29s   <span class=\"token number\">192.168</span>.52.1      ip-10-0-3-160.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></code></pre></div>\n<p>예상과 달리 zone A에 노드가 2개 생성됨\n현재 zone A에는 노드가 4개, zone B에는 노드가 2개 존재</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k get no</span>\nNAME                                            STATUS   ROLES                  AGE    VERSION\nip-10-0-3-100.ap-northeast-2.compute.internal   Ready    control-plane,master   9h     v1.21.1\nip-10-0-3-111.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 2m     v1.21.1\nip-10-0-3-116.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 30m    v1.21.1\nip-10-0-3-160.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 2m     v1.21.1\nip-10-0-3-38.ap-northeast-2.compute.internal    Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 178m   v1.21.1\nip-10-0-4-142.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 18m    v1.21.1\nip-10-0-4-186.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 12m    v1.21.1</code></pre></div>\n<p><code class=\"language-text\">--balance-similar-node-groups</code> 옵션을 이용하여 이를 해결 가능</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># cluster-autoscaler.yaml</span>\n\t\t<span class=\"token punctuation\">...</span>\n\t\t<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n\t\t\t<span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> k8s.gcr.io/autoscaling/cluster<span class=\"token punctuation\">-</span>autoscaler<span class=\"token punctuation\">:</span>v1.22.2\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> cluster<span class=\"token punctuation\">-</span>autoscaler\n          <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> ./cluster<span class=\"token punctuation\">-</span>autoscaler\n            <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>v=4\n            <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>stderrthreshold=info\n            <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>cloud<span class=\"token punctuation\">-</span>provider=aws\n            <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>skip<span class=\"token punctuation\">-</span>nodes<span class=\"token punctuation\">-</span>with<span class=\"token punctuation\">-</span>local<span class=\"token punctuation\">-</span>storage=false\n            <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>balance<span class=\"token punctuation\">-</span>similar<span class=\"token punctuation\">-</span>node<span class=\"token punctuation\">-</span>groups  <span class=\"token comment\"># 옵션 추가</span></code></pre></div>\n<p>다시 테스트를 수행해보면 옵션이 적용되어 균형을 맞춰 노드가 생성되고 self healing 진행</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k logs cluster-autoscaler-5fbf84697-jlq6w -n kube-system</span>\n<span class=\"token punctuation\">..</span>\nI1223 <span class=\"token number\">17</span>:02:11.289518       <span class=\"token number\">1</span> filter_out_schedulable.go:157<span class=\"token punctuation\">]</span> Pod default.nginx-deploy-78d865fc9b-q4s72 marked as unschedulable can be scheduled on <span class=\"token function\">node</span> template-node-for-terraform-20221223072925690300000012-6177026811335423860-upcoming-0. Ignoring <span class=\"token keyword\">in</span> scale up.\nI1223 <span class=\"token number\">17</span>:02:11.289639       <span class=\"token number\">1</span> filter_out_schedulable.go:157<span class=\"token punctuation\">]</span> Pod default.nginx-deploy-78d865fc9b-58ch8 marked as unschedulable can be scheduled on <span class=\"token function\">node</span> template-node-for-terraform-20221223072925690300000012-6177026811335423860-upcoming-0. Ignoring <span class=\"token keyword\">in</span> scale up.\nI1223 <span class=\"token number\">17</span>:02:11.289775       <span class=\"token number\">1</span> filter_out_schedulable.go:157<span class=\"token punctuation\">]</span> Pod default.nginx-deploy-78d865fc9b-jh65t marked as unschedulable can be scheduled on <span class=\"token function\">node</span> template-node-for-terraform-20221223072925690300000012-6177026811335423860-upcoming-0. Ignoring <span class=\"token keyword\">in</span> scale up.\nI1223 <span class=\"token number\">17</span>:02:11.289915       <span class=\"token number\">1</span> filter_out_schedulable.go:157<span class=\"token punctuation\">]</span> Pod default.nginx-deploy-78d865fc9b-s8gjh marked as unschedulable can be scheduled on <span class=\"token function\">node</span> template-node-for-terraform-20221223072925690300000013-7979830878773245174-upcoming-0. Ignoring <span class=\"token keyword\">in</span> scale up.\nI1223 <span class=\"token number\">17</span>:02:11.290011       <span class=\"token number\">1</span> filter_out_schedulable.go:157<span class=\"token punctuation\">]</span> Pod default.nginx-deploy-78d865fc9b-l8dl4 marked as unschedulable can be scheduled on <span class=\"token function\">node</span> template-node-for-terraform-20221223072925690300000013-7979830878773245174-upcoming-0. Ignoring <span class=\"token keyword\">in</span> scale up.\nI1223 <span class=\"token number\">17</span>:02:11.290110       <span class=\"token number\">1</span> filter_out_schedulable.go:157<span class=\"token punctuation\">]</span> Pod default.nginx-deploy-78d865fc9b-m6vxq marked as unschedulable can be scheduled on <span class=\"token function\">node</span> template-node-for-terraform-20221223072925690300000013-7979830878773245174-upcoming-0. Ignoring <span class=\"token keyword\">in</span> scale up.\nI1223 <span class=\"token number\">17</span>:02:11.290158       <span class=\"token number\">1</span> filter_out_schedulable.go:170<span class=\"token punctuation\">]</span> <span class=\"token number\">0</span> pods were kept as unschedulable based on caching\nI1223 <span class=\"token number\">17</span>:02:11.290169       <span class=\"token number\">1</span> filter_out_schedulable.go:171<span class=\"token punctuation\">]</span> <span class=\"token number\">6</span> pods marked as unschedulable can be scheduled.</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k get no</span>\nNAME                                            STATUS   ROLES                  AGE     VERSION\nip-10-0-3-100.ap-northeast-2.compute.internal   Ready    control-plane,master   9h      v1.21.1\nip-10-0-3-111.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 22m     v1.21.1\nip-10-0-3-125.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 2m39s   v1.21.1\nip-10-0-3-38.ap-northeast-2.compute.internal    Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 3h18m   v1.21.1\nip-10-0-4-133.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 2m53s   v1.21.1\nip-10-0-4-142.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 39m     v1.21.1\nip-10-0-4-186.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 33m     v1.21.1</code></pre></div>\n<p>스케일 아웃도 <code class=\"language-text\">--balance-similar-node-groups</code> 옵션이 존재하지 않으면 특정 가용 영역에만 노드가 생성됨</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k logs cluster-autoscaler-5fc547f877-n4sjr -n kube-system</span>\n<span class=\"token punctuation\">..</span>\n<span class=\"token comment\"># 현재 expander 옵션으로 least-waste 사용</span>\nI1223 <span class=\"token number\">17</span>:13:41.549539       <span class=\"token number\">1</span> waste.go:57<span class=\"token punctuation\">]</span> Expanding Node Group terraform-20221223072925690300000012 would waste <span class=\"token number\">25.00</span>% CPU, <span class=\"token number\">80.12</span>% Memory, <span class=\"token number\">52.56</span>% Blended\nI1223 <span class=\"token number\">17</span>:13:41.549562       <span class=\"token number\">1</span> waste.go:57<span class=\"token punctuation\">]</span> Expanding Node Group terraform-20221223072925690300000013 would waste <span class=\"token number\">25.00</span>% CPU, <span class=\"token number\">80.12</span>% Memory, <span class=\"token number\">52.56</span>% Blended\nI1223 <span class=\"token number\">17</span>:13:41.549576       <span class=\"token number\">1</span> scale_up.go:468<span class=\"token punctuation\">]</span> Best option to resize: terraform-20221223072925690300000013\nI1223 <span class=\"token number\">17</span>:13:41.549586       <span class=\"token number\">1</span> scale_up.go:472<span class=\"token punctuation\">]</span> Estimated <span class=\"token number\">2</span> nodes needed <span class=\"token keyword\">in</span> terraform-20221223072925690300000013\nI1223 <span class=\"token number\">17</span>:13:41.549608       <span class=\"token number\">1</span> scale_up.go:586<span class=\"token punctuation\">]</span> Final scale-up plan: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>terraform-20221223072925690300000013 <span class=\"token number\">2</span>-<span class=\"token operator\">></span><span class=\"token number\">4</span> <span class=\"token punctuation\">(</span>max: <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\nI1223 <span class=\"token number\">17</span>:13:41.549634       <span class=\"token number\">1</span> scale_up.go:675<span class=\"token punctuation\">]</span> Scale-up: setting group terraform-20221223072925690300000013 size to <span class=\"token number\">4</span>\nI1223 <span class=\"token number\">17</span>:13:41.549665       <span class=\"token number\">1</span> auto_scaling_groups.go:219<span class=\"token punctuation\">]</span> Setting asg terraform-20221223072925690300000013 size to <span class=\"token number\">4</span></code></pre></div>\n<p>마찬가지로 <code class=\"language-text\">--balance-similar-node-groups</code> 옵션 적용 후 균형을 맞춰 스케일 아웃 진행</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k logs cluster-autoscaler-5fbf84697-pkx9r -n kub</span>\n<span class=\"token punctuation\">..</span>\n<span class=\"token comment\"># 현재 expander 옵션으로 least-waste 사용</span>\nI1223 <span class=\"token number\">17</span>:29:42.923429       <span class=\"token number\">1</span> waste.go:57<span class=\"token punctuation\">]</span> Expanding Node Group terraform-20221223072925690300000013 would waste <span class=\"token number\">25.00</span>% CPU, <span class=\"token number\">80.12</span>% Memory, <span class=\"token number\">52.56</span>% Blended\nI1223 <span class=\"token number\">17</span>:29:42.923564       <span class=\"token number\">1</span> waste.go:57<span class=\"token punctuation\">]</span> Expanding Node Group terraform-20221223072925690300000012 would waste <span class=\"token number\">25.00</span>% CPU, <span class=\"token number\">80.12</span>% Memory, <span class=\"token number\">52.56</span>% Blended\nI1223 <span class=\"token number\">17</span>:29:42.923639       <span class=\"token number\">1</span> scale_up.go:468<span class=\"token punctuation\">]</span> Best option to resize: terraform-20221223072925690300000013\nI1223 <span class=\"token number\">17</span>:29:42.923699       <span class=\"token number\">1</span> scale_up.go:472<span class=\"token punctuation\">]</span> Estimated <span class=\"token number\">2</span> nodes needed <span class=\"token keyword\">in</span> terraform-20221223072925690300000013\nI1223 <span class=\"token number\">17</span>:29:42.923806       <span class=\"token number\">1</span> scale_up.go:578<span class=\"token punctuation\">]</span> Splitting scale-up between <span class=\"token number\">2</span> similar <span class=\"token function\">node</span> groups: <span class=\"token punctuation\">{</span>terraform-20221223072925690300000013, terraform-20221223072925690300000012<span class=\"token punctuation\">}</span>\nI1223 <span class=\"token number\">17</span>:29:42.923885       <span class=\"token number\">1</span> scale_up.go:586<span class=\"token punctuation\">]</span> Final scale-up plan: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>terraform-20221223072925690300000013 <span class=\"token number\">2</span>-<span class=\"token operator\">></span><span class=\"token number\">3</span> <span class=\"token punctuation\">(</span>max: <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span> <span class=\"token punctuation\">{</span>terraform-20221223072925690300000012 <span class=\"token number\">2</span>-<span class=\"token operator\">></span><span class=\"token number\">3</span> <span class=\"token punctuation\">(</span>max: <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\nI1223 <span class=\"token number\">17</span>:29:42.923947       <span class=\"token number\">1</span> scale_up.go:675<span class=\"token punctuation\">]</span> Scale-up: setting group terraform-20221223072925690300000013 size to <span class=\"token number\">3</span>\nI1223 <span class=\"token number\">17</span>:29:42.924047       <span class=\"token number\">1</span> auto_scaling_groups.go:219<span class=\"token punctuation\">]</span> Setting asg terraform-20221223072925690300000013 size to <span class=\"token number\">3</span></code></pre></div>\n<p>공식문서에 따르면 <code class=\"language-text\">--balance-similar-node-groups</code> 옵션을 이용하여 topolgy scheduling 없이도 node group의 균형을 맞추는 것이 가능하다고 함</p>\n<p><code class=\"language-text\">3 AutoScalingGroup</code> + <code class=\"language-text\">3 Deployment</code></p>\n<p><img src=\"https://user-images.githubusercontent.com/59433441/209476491-4db1fca8-8330-4101-849e-7acb4f53404c.png\" alt=\"3asg + 3deploy\"></p>\n<p>3개의 배포를 수행하여 수동으로 각 가용 영역에 균등하게 배포 가능<br>\n-> <code class=\"language-text\">1 AutoScalingGroup</code> + <code class=\"language-text\">3 Deployment</code> 방법과 같은 방식으로 배포</p>\n<p>3개의 배포를 관리해야 하므로 관리 포인트가 증가(hpa도 3개 관리해야 함)</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k get deploy</span>\nNAME             READY   UP-TO-DATE   AVAILABLE   AGE\nnginx-deploy-a   <span class=\"token number\">2</span>/2     <span class=\"token number\">2</span>            <span class=\"token number\">2</span>           44s\nnginx-deploy-b   <span class=\"token number\">2</span>/2     <span class=\"token number\">2</span>            <span class=\"token number\">2</span>           42s\nnginx-deploy-c   <span class=\"token number\">2</span>/2     <span class=\"token number\">2</span>            <span class=\"token number\">2</span>           38s</code></pre></div>\n<p>cluster autoscaler가 특정 가용 영역을 찾기 위한 오버헤드가 존재하지 않음<br>\n위의 <code class=\"language-text\">1 AutoScalingGroup</code> + <code class=\"language-text\">3 Deployment</code>와 달리 개별 asg를 갖고 있으므로 cluster autoscaler가 스케일 아웃을 여러번 시도하지 않아도 됨<br>\n테스트를 위해 zone B에 레플리카 수 조정</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k scale deploy nginx-deploy-b --replicas=9</span>\ndeployment.apps/nginx-deploy-b scaled</code></pre></div>\n<p>개별 배포를 수행했으므로 <code class=\"language-text\">--balance-similar-node-groups</code> 옵션이 없어도 됨</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k logs cluster-autoscaler-5fbf84697-pkx9r -n kube-system</span>\n<span class=\"token punctuation\">..</span>\nI1223 <span class=\"token number\">17</span>:44:57.343385       <span class=\"token number\">1</span> klogx.go:86<span class=\"token punctuation\">]</span> Pod default/nginx-deploy-b-58f74dd7b9-8jbzx is unschedulable\nI1223 <span class=\"token number\">17</span>:44:57.343391       <span class=\"token number\">1</span> klogx.go:86<span class=\"token punctuation\">]</span> Pod default/nginx-deploy-b-58f74dd7b9-lcvw5 is unschedulable\nI1223 <span class=\"token number\">17</span>:44:57.343397       <span class=\"token number\">1</span> klogx.go:86<span class=\"token punctuation\">]</span> Pod default/nginx-deploy-b-58f74dd7b9-gfvxm is unschedulable\nI1223 <span class=\"token number\">17</span>:44:57.343449       <span class=\"token number\">1</span> scale_up.go:376<span class=\"token punctuation\">]</span> Upcoming <span class=\"token number\">0</span> nodes\n<span class=\"token comment\"># 먼저 zone A에 스케일이 가능한지 검사하지만 node affinity 설정으로 인해 스케줄링 될 수 없음</span>\nI1223 <span class=\"token number\">17</span>:44:57.343533       <span class=\"token number\">1</span> scale_up.go:300<span class=\"token punctuation\">]</span> Pod nginx-deploy-b-58f74dd7b9-gfvxm can<span class=\"token string\">'t be scheduled on terraform-20221223072925690300000012, predicate checking error: node(s) didn'</span>t match Pod<span class=\"token string\">'s node affinity/selector; predicateName=NodeAffinity; reasons: node(s) didn'</span>t match Pod<span class=\"token string\">'s node affinity/selector; debugInfo=\nI1223 17:44:57.343556       1 scale_up.go:300] Pod nginx-deploy-b-58f74dd7b9-8jbzx can'</span>t be scheduled on terraform-20221223072925690300000012, predicate checking error: node<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> didn<span class=\"token string\">'t match Pod'</span>s <span class=\"token function\">node</span> affinity/selector<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">predicateName</span><span class=\"token operator\">=</span>NodeAffinity<span class=\"token punctuation\">;</span> reasons: node<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> didn<span class=\"token string\">'t match Pod'</span>s <span class=\"token function\">node</span> affinity/selector<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">debugInfo</span><span class=\"token operator\">=</span>\nI1223 <span class=\"token number\">17</span>:44:57.343581       <span class=\"token number\">1</span> scale_up.go:300<span class=\"token punctuation\">]</span> Pod nginx-deploy-b-58f74dd7b9-lcvw5 can<span class=\"token string\">'t be scheduled on terraform-20221223072925690300000012, predicate checking error: node(s) didn'</span>t match Pod<span class=\"token string\">'s node affinity/selector; predicateName=NodeAffinity; reasons: node(s) didn'</span>t match Pod's <span class=\"token function\">node</span> affinity/selector<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">debugInfo</span><span class=\"token operator\">=</span>\nI1223 <span class=\"token number\">17</span>:44:57.343605       <span class=\"token number\">1</span> scale_up.go:449<span class=\"token punctuation\">]</span> No pod can fit to terraform-20221223072925690300000012\n<span class=\"token comment\"># 현재 expander 옵션으로 least-waste 사용</span>\nI1223 <span class=\"token number\">17</span>:44:57.343843       <span class=\"token number\">1</span> waste.go:57<span class=\"token punctuation\">]</span> Expanding Node Group terraform-20221223072925690300000013 would waste <span class=\"token number\">25.00</span>% CPU, <span class=\"token number\">80.12</span>% Memory, <span class=\"token number\">52.56</span>% Blended\nI1223 <span class=\"token number\">17</span>:44:57.343871       <span class=\"token number\">1</span> scale_up.go:468<span class=\"token punctuation\">]</span> Best option to resize: terraform-20221223072925690300000013\nI1223 <span class=\"token number\">17</span>:44:57.343882       <span class=\"token number\">1</span> scale_up.go:472<span class=\"token punctuation\">]</span> Estimated <span class=\"token number\">1</span> nodes needed <span class=\"token keyword\">in</span> terraform-20221223072925690300000013\nI1223 <span class=\"token number\">17</span>:44:57.343934       <span class=\"token number\">1</span> scale_up.go:655<span class=\"token punctuation\">]</span> No info about pods passing predicates found <span class=\"token keyword\">for</span> group terraform-20221223072925690300000012, skipping it from scale-up consideration\n<span class=\"token comment\"># zone B에 스케일 아웃 진행</span>\nI1223 <span class=\"token number\">17</span>:44:57.343948       <span class=\"token number\">1</span> scale_up.go:586<span class=\"token punctuation\">]</span> Final scale-up plan: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>terraform-20221223072925690300000013 <span class=\"token number\">2</span>-<span class=\"token operator\">></span><span class=\"token number\">3</span> <span class=\"token punctuation\">(</span>max: <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\nI1223 <span class=\"token number\">17</span>:44:57.343963       <span class=\"token number\">1</span> scale_up.go:675<span class=\"token punctuation\">]</span> Scale-up: setting group terraform-20221223072925690300000013 size to <span class=\"token number\">3</span>\nI1223 <span class=\"token number\">17</span>:44:57.344167       <span class=\"token number\">1</span> auto_scaling_groups.go:219<span class=\"token punctuation\">]</span> Setting asg terraform-20221223072925690300000013 size to <span class=\"token number\">3</span></code></pre></div>\n<p>특정 가용 영역이 다운됐을 경우 self healing되지 않음\n특정 가용 영역 다운(zone B에 설정한 asg 삭제)</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k get no</span>\nNAME                                            STATUS   ROLES                  AGE   VERSION\nip-10-0-3-100.ap-northeast-2.compute.internal   Ready    control-plane,master   10h   v1.21.1\nip-10-0-3-125.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 55m   v1.21.1\nip-10-0-3-143.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 25m   v1.21.1\nip-10-0-5-106.ap-northeast-2.compute.internal   Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 46m   v1.21.1\nip-10-0-5-9.ap-northeast-2.compute.internal     Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                 46m   v1.21.1</code></pre></div>\n<p>해당 가용 영역에서 실행 중이던 노드가 다운되면서 self healing을 시도하지만 개별 배포를 진행했으므로 마이그레이션 되지 않음</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k get po -o wide</span>\nNAME                              READY   STATUS    RESTARTS   AGE     IP                NODE                                            NOMINATED NODE   READINESS GATES\nnginx-deploy-a-5587c665fb-dsqhj   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          9m25s   <span class=\"token number\">192.168</span>.157.205   ip-10-0-3-125.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-a-5587c665fb-gnltb   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          9m25s   <span class=\"token number\">192.168</span>.157.206   ip-10-0-3-125.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-a-5587c665fb-gtj9w   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          9m25s   <span class=\"token number\">192.168</span>.144.69    ip-10-0-3-143.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-a-5587c665fb-l9kz9   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          21m     <span class=\"token number\">192.168</span>.157.204   ip-10-0-3-125.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-a-5587c665fb-pmcmk   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          21m     <span class=\"token number\">192.168</span>.144.68    ip-10-0-3-143.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-a-5587c665fb-t22n6   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          9m25s   <span class=\"token number\">192.168</span>.144.70    ip-10-0-3-143.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-b-58f74dd7b9-75s8l   <span class=\"token number\">0</span>/1     Pending   <span class=\"token number\">0</span>          27s     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>            <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                                          <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-b-58f74dd7b9-9hzvt   <span class=\"token number\">0</span>/1     Pending   <span class=\"token number\">0</span>          27s     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>            <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                                          <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-b-58f74dd7b9-dgmq9   <span class=\"token number\">0</span>/1     Pending   <span class=\"token number\">0</span>          27s     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>            <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                                          <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-b-58f74dd7b9-m6v42   <span class=\"token number\">0</span>/1     Pending   <span class=\"token number\">0</span>          47s     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>            <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                                          <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-b-58f74dd7b9-pqcpm   <span class=\"token number\">0</span>/1     Pending   <span class=\"token number\">0</span>          47s     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>            <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                                          <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-b-58f74dd7b9-qk5rs   <span class=\"token number\">0</span>/1     Pending   <span class=\"token number\">0</span>          47s     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>            <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>                                          <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-c-75764c77db-67vnw   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          9m22s   <span class=\"token number\">192.168</span>.199.140   ip-10-0-5-9.ap-northeast-2.compute.internal     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-c-75764c77db-8zh45   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          9m22s   <span class=\"token number\">192.168</span>.77.139    ip-10-0-5-106.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-c-75764c77db-bcdcd   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          9m23s   <span class=\"token number\">192.168</span>.77.138    ip-10-0-5-106.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-c-75764c77db-fz4zq   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          9m22s   <span class=\"token number\">192.168</span>.199.139   ip-10-0-5-9.ap-northeast-2.compute.internal     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-c-75764c77db-lc9z2   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          21m     <span class=\"token number\">192.168</span>.199.138   ip-10-0-5-9.ap-northeast-2.compute.internal     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>\nnginx-deploy-c-75764c77db-slwwm   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          21m     <span class=\"token number\">192.168</span>.77.137    ip-10-0-5-106.ap-northeast-2.compute.internal   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></code></pre></div>\n<p>cluster autoscaler도 스케일 아웃 가능한 asg를 찾을 수 없음(상태 유지)</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># k logs cluster-autoscaler-5fbf84697-pkx9r -n kube-system</span>\n<span class=\"token punctuation\">..</span>\nI1223 <span class=\"token number\">18</span>:01:31.932937       <span class=\"token number\">1</span> scale_up.go:300<span class=\"token punctuation\">]</span> Pod nginx-deploy-b-58f74dd7b9-m6v42 can<span class=\"token string\">'t be scheduled on terraform-20221223072925690300000012, predicate checking error: node(s) didn'</span>t match Pod<span class=\"token string\">'s node affinity/selector; predicateName=NodeAffinity; reasons: node(s) didn'</span>t match Pod<span class=\"token string\">'s node affinity/selector; debugInfo=\nI1223 18:01:31.933117       1 scale_up.go:300] Pod nginx-deploy-b-58f74dd7b9-qk5rs can'</span>t be scheduled on terraform-20221223072925690300000012, predicate checking error: node<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> didn<span class=\"token string\">'t match Pod'</span>s <span class=\"token function\">node</span> affinity/selector<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">predicateName</span><span class=\"token operator\">=</span>NodeAffinity<span class=\"token punctuation\">;</span> reasons: node<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> didn<span class=\"token string\">'t match Pod'</span>s <span class=\"token function\">node</span> affinity/selector<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">debugInfo</span><span class=\"token operator\">=</span>\nI1223 <span class=\"token number\">18</span>:01:31.933202       <span class=\"token number\">1</span> scale_up.go:300<span class=\"token punctuation\">]</span> Pod nginx-deploy-b-58f74dd7b9-pqcpm can<span class=\"token string\">'t be scheduled on terraform-20221223072925690300000012, predicate checking error: node(s) didn'</span>t match Pod<span class=\"token string\">'s node affinity/selector; predicateName=NodeAffinity; reasons: node(s) didn'</span>t match Pod<span class=\"token string\">'s node affinity/selector; debugInfo=\nI1223 18:01:31.933325       1 scale_up.go:300] Pod nginx-deploy-b-58f74dd7b9-9hzvt can'</span>t be scheduled on terraform-20221223072925690300000012, predicate checking error: node<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> didn<span class=\"token string\">'t match Pod'</span>s <span class=\"token function\">node</span> affinity/selector<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">predicateName</span><span class=\"token operator\">=</span>NodeAffinity<span class=\"token punctuation\">;</span> reasons: node<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> didn<span class=\"token string\">'t match Pod'</span>s <span class=\"token function\">node</span> affinity/selector<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">debugInfo</span><span class=\"token operator\">=</span>\nI1223 <span class=\"token number\">18</span>:01:31.933418       <span class=\"token number\">1</span> scale_up.go:300<span class=\"token punctuation\">]</span> Pod nginx-deploy-b-58f74dd7b9-75s8l can<span class=\"token string\">'t be scheduled on terraform-20221223072925690300000012, predicate checking error: node(s) didn'</span>t match Pod<span class=\"token string\">'s node affinity/selector; predicateName=NodeAffinity; reasons: node(s) didn'</span>t match Pod<span class=\"token string\">'s node affinity/selector; debugInfo=\nI1223 18:01:31.933499       1 scale_up.go:300] Pod nginx-deploy-b-58f74dd7b9-dgmq9 can'</span>t be scheduled on terraform-20221223072925690300000012, predicate checking error: node<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> didn<span class=\"token string\">'t match Pod'</span>s <span class=\"token function\">node</span> affinity/selector<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">predicateName</span><span class=\"token operator\">=</span>NodeAffinity<span class=\"token punctuation\">;</span> reasons: node<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> didn<span class=\"token string\">'t match Pod'</span>s <span class=\"token function\">node</span> affinity/selector<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">debugInfo</span><span class=\"token operator\">=</span>\nI1223 <span class=\"token number\">18</span>:01:31.933593       <span class=\"token number\">1</span> scale_up.go:449<span class=\"token punctuation\">]</span> No pod can fit to terraform-20221223072925690300000012\nI1223 <span class=\"token number\">18</span>:01:31.933755       <span class=\"token number\">1</span> scale_up.go:300<span class=\"token punctuation\">]</span> Pod nginx-deploy-b-58f74dd7b9-m6v42 can<span class=\"token string\">'t be scheduled on terraform-20221223072925690300000014, predicate checking error: node(s) didn'</span>t match Pod<span class=\"token string\">'s node affinity/selector; predicateName=NodeAffinity; reasons: node(s) didn'</span>t match Pod<span class=\"token string\">'s node affinity/selector; debugInfo=\nI1223 18:01:31.933854       1 scale_up.go:300] Pod nginx-deploy-b-58f74dd7b9-qk5rs can'</span>t be scheduled on terraform-20221223072925690300000014, predicate checking error: node<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> didn<span class=\"token string\">'t match Pod'</span>s <span class=\"token function\">node</span> affinity/selector<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">predicateName</span><span class=\"token operator\">=</span>NodeAffinity<span class=\"token punctuation\">;</span> reasons: node<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> didn<span class=\"token string\">'t match Pod'</span>s <span class=\"token function\">node</span> affinity/selector<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">debugInfo</span><span class=\"token operator\">=</span>\nI1223 <span class=\"token number\">18</span>:01:31.933945       <span class=\"token number\">1</span> scale_up.go:300<span class=\"token punctuation\">]</span> Pod nginx-deploy-b-58f74dd7b9-pqcpm can<span class=\"token string\">'t be scheduled on terraform-20221223072925690300000014, predicate checking error: node(s) didn'</span>t match Pod<span class=\"token string\">'s node affinity/selector; predicateName=NodeAffinity; reasons: node(s) didn'</span>t match Pod<span class=\"token string\">'s node affinity/selector; debugInfo=\nI1223 18:01:31.934034       1 scale_up.go:300] Pod nginx-deploy-b-58f74dd7b9-9hzvt can'</span>t be scheduled on terraform-20221223072925690300000014, predicate checking error: node<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> didn<span class=\"token string\">'t match Pod'</span>s <span class=\"token function\">node</span> affinity/selector<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">predicateName</span><span class=\"token operator\">=</span>NodeAffinity<span class=\"token punctuation\">;</span> reasons: node<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> didn<span class=\"token string\">'t match Pod'</span>s <span class=\"token function\">node</span> affinity/selector<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">debugInfo</span><span class=\"token operator\">=</span>\nI1223 <span class=\"token number\">18</span>:01:31.934110       <span class=\"token number\">1</span> scale_up.go:300<span class=\"token punctuation\">]</span> Pod nginx-deploy-b-58f74dd7b9-75s8l can<span class=\"token string\">'t be scheduled on terraform-20221223072925690300000014, predicate checking error: node(s) didn'</span>t match Pod<span class=\"token string\">'s node affinity/selector; predicateName=NodeAffinity; reasons: node(s) didn'</span>t match Pod<span class=\"token string\">'s node affinity/selector; debugInfo=\nI1223 18:01:31.934189       1 scale_up.go:300] Pod nginx-deploy-b-58f74dd7b9-dgmq9 can'</span>t be scheduled on terraform-20221223072925690300000014, predicate checking error: node<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> didn<span class=\"token string\">'t match Pod'</span>s <span class=\"token function\">node</span> affinity/selector<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">predicateName</span><span class=\"token operator\">=</span>NodeAffinity<span class=\"token punctuation\">;</span> reasons: node<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> didn<span class=\"token string\">'t match Pod'</span>s <span class=\"token function\">node</span> affinity/selector<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">debugInfo</span><span class=\"token operator\">=</span>\nI1223 <span class=\"token number\">18</span>:01:31.934273       <span class=\"token number\">1</span> scale_up.go:449<span class=\"token punctuation\">]</span> No pod can fit to terraform-20221223072925690300000014</code></pre></div>\n<h3>결론</h3>\n<ul>\n<li>개별 배포가 필요하지 않은 경우라면 하나의 배포를 수행한다.\n<ul>\n<li>개별 배포를 수행할 경우 관리 지점이 늘어난다.</li>\n<li>가용 영역 별로 세밀한 배포가 필요한 경우에는 개별 배포를 수행한다.</li>\n</ul>\n</li>\n<li>각 가용 영역에 개별 배포가 필요한 경우(예: PV로 AWS EBS를 사용하는 경우) 3개의 ASG를 이용한다.\n<ul>\n<li>하나의 ASG를 이용할 경우 Cluster Autoscaler가 스케일이 필요한 가용 영역을 찾는데 오버헤드가 발생한다.</li>\n</ul>\n</li>\n<li>모든 가용 영역에 하나의 배포를 수행할 경우 1개 또는 3개의 ASG를 사용할 수 있다.\n<ul>\n<li>1개의 ASG를 이용할 경우 AWS ASG에 의존하여 스케일링 한다.\n<ul>\n<li>기본적으로 AWS ASG는 가용 영역 간의 노드 수 균형을 유지하며 스케일링 한다.</li>\n</ul>\n</li>\n<li>3개의 ASG를 이용할 경우 Cluster Autoscaler에 의존하여 스케일링 한다.\n<ul>\n<li>Cluster Autoscaler의 <code class=\"language-text\">--balance-similar-node-groups</code> 옵션을 이용하여 가용 영역 간의 노드 수 균형을 유지할 수 있다.</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>","fields":{"readingTime":{"text":"28 min read"}},"frontmatter":{"title":"다중 가용 영역 클러스터에 Cluster Autoscaler 도입하기","date":"December 26, 2022"}}},"pageContext":{"slug":"/ca-in-multiple-az-cluster/","previous":{"fields":{"slug":"/ingress-nginx-413/"},"frontmatter":{"title":"Ingress nginx 413 에러 해결하기","tags":["kubernetes"]}},"next":null}},"staticQueryHashes":["3649515864","461697574","983108779"],"slicesMap":{}}